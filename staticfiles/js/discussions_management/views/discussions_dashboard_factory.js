/*
** Checkboxes TreeView- jQuery
** https://github.com/aexmachina/jquery-qubit
**
** Copyright (c) 2014 Simon Wade
** The MIT License (MIT)
** https://github.com/aexmachina/jquery-qubit/blob/master/LICENSE.txt
**
*/

(function(e){var i=e.Model.extend({defaults:{type:"confirmation",title:"",message:"",details:[],actionText:null,actionClass:"",actionIconClass:"",actionCallback:null}});this.NotificationModel=i}).call(this,Backbone),RequireJS.define("js/models/notification",function(){}),function(e,i,s){var t=e.View.extend({events:{"click .action-primary":"triggerCallback"},initialize:function(){this.template=s.template(i("#notification-tpl").text())},render:function(){return this.$el.html(this.template({type:this.model.get("type"),title:this.model.get("title"),message:this.model.get("message"),details:this.model.get("details"),actionText:this.model.get("actionText"),actionClass:this.model.get("actionClass"),actionIconClass:this.model.get("actionIconClass")})),this.$(".message").focus(),this},triggerCallback:function(e){e.preventDefault();var i=this.model.get("actionCallback");i&&i(this)}});this.NotificationView=t}.call(this,Backbone,$,_),RequireJS.define("js/views/notification",function(){}),function(e){"use strict";RequireJS.define("js/discussions_management/views/divided_discussions",["jquery","underscore","backbone","gettext","js/models/notification","js/views/notification"],function(e,i,s,t){var n=s.View.extend({setDisabled:function(e,i){e.prop("disabled",i?"disabled":!1)},getDividedDiscussions:function(s){var t=this,n=[];return i.each(t.$(s),function(i){n.push(e(i).data("id"))}),n},saveForm:function(i,s){var n,o=this,c=this.discussionSettings,a=e.Deferred();return n=function(e){o.showMessage(e,i,"error")},this.removeNotification(),c.save(s,{patch:!0,wait:!0}).done(function(){a.resolve()}).fail(function(e){var i,s=null;try{i=JSON.parse(e.responseText),s=i.error}catch(o){}s||(s=t("We've encountered an error. Refresh your browser and then try again.")),n(s),a.reject()}),a.promise()},showMessage:function(e,i,s){var t=new NotificationModel({type:s||"confirmation",title:e});this.removeNotification(),this.notification=new NotificationView({model:t}),i.before(this.notification.$el),this.notification.render()},removeNotification:function(){this.notification&&this.notification.remove()}});return n})}.call(this,define||RequireJS.define),function(e){e.fn.qubit=function(e){return this.each(function(){new i(this,e)})};var i=function(i){var s=this;this.scope=e(i),this.scope.on("change","input[type=checkbox]",function(e){s.suspendListeners||s.process(e.target)}),this.scope.find("input[type=checkbox]:checked").each(function(){s.process(this)})};i.prototype={itemSelector:"li",process:function(i){var i=e(i),s=i.parentsUntil(this.scope,this.itemSelector);try{this.suspendListeners=!0,s.eq(0).find("input[type=checkbox]").filter(i.prop("checked")?":not(:checked)":":checked").each(function(){e(this).parent().hasClass("hidden")||e(this).prop("checked",i.prop("checked"))}).trigger("change"),this.processParents(i)}finally{this.suspendListeners=!1}},processParents:function(){var i=this,s=!1;this.scope.find("input[type=checkbox]").each(function(){var t=e(this),n=t.closest(i.itemSelector),o=n.find("input[type=checkbox]").not(t),c=o.filter(function(){return e(this).prop("checked")||e(this).prop("indeterminate")}).length;o.length?0==c?i.setChecked(t,!1)&&(s=!0):c==o.length?i.setChecked(t,!0)&&(s=!0):i.setIndeterminate(t,!0)&&(s=!0):i.setIndeterminate(t,!1)&&(s=!0)}),s&&this.processParents()},setChecked:function(e,i,s){var t=!1;return e.prop("indeterminate")&&(e.prop("indeterminate",!1),t=!0),e.prop("checked")!=i&&(e.prop("checked",i).trigger("change"),t=!0),t},setIndeterminate:function(e,i){return i&&e.prop("checked",!1),e.prop("indeterminate")!=i?(e.prop("indeterminate",i),!0):void 0}}}(jQuery),RequireJS.define("js/vendor/jquery.qubit",function(){}),function(e){"use strict";RequireJS.define("js/discussions_management/views/divided_discussions_inline",["jquery","underscore","backbone","gettext","js/discussions_management/views/divided_discussions","edx-ui-toolkit/js/utils/html-utils","js/vendor/jquery.qubit"],function(e,i,s,t,n,o){var c=n.extend({events:{"change .check-discussion-category":"setSaveButton","change .check-discussion-subcategory-inline":"setSaveButton","click .cohort-inline-discussions-form .action-save":"saveInlineDiscussionsForm","change .check-all-inline-discussions":"setAllInlineDiscussions","change .check-cohort-inline-discussions":"setSomeInlineDiscussions"},initialize:function(i){this.template=o.template(e("#divided-discussions-inline-tpl").text()),this.discussionSettings=i.discussionSettings},render:function(){var e=this.model.get("inline_discussions"),i=this.discussionSettings.get("always_divide_inline_discussions");o.setHtml(this.$(".inline-discussions-nav"),this.template({inlineDiscussionTopicsHtml:this.getInlineDiscussionsHtml(e),alwaysDivideInlineDiscussions:i})),this.$("ul.inline-topics").qubit(),this.setElementsEnabled(i,!0)},getInlineDiscussionsHtml:function(s){var t=o.template(e("#cohort-discussions-category-tpl").html()),n=o.template(e("#cohort-discussions-subcategory-tpl").html()),c=!1,a=s.children,d=s.entries,r=s.subcategories;return o.joinHtml.apply(this,i.map(a,function(e){var s,o="",a=e[0],u=e[1];return d&&i.has(d,a)&&"entry"===u?(s=d[a],o=n({name:a,id:s.id,is_divided:s.is_divided,type:"inline"})):o=t({name:a,entriesHtml:this.getInlineDiscussionsHtml(r[a]),isCategoryCohorted:c}),o},this))},setAllInlineDiscussions:function(i){i.preventDefault(),this.setElementsEnabled(e(i.currentTarget).prop("checked"),!1)},setSomeInlineDiscussions:function(i){i.preventDefault(),this.setElementsEnabled(!e(i.currentTarget).prop("checked"),!1)},setElementsEnabled:function(e,i){this.setDisabled(this.$(".check-discussion-category"),e),this.setDisabled(this.$(".check-discussion-subcategory-inline"),e),this.setDisabled(this.$(".cohort-inline-discussions-form .action-save"),i)},setSaveButton:function(){this.setDisabled(this.$(".cohort-inline-discussions-form .action-save"),!1)},saveInlineDiscussionsForm:function(e){var i=this,s=i.getDividedDiscussions(".check-discussion-subcategory-inline:checked"),n={divided_inline_discussions:s,always_divide_inline_discussions:i.$(".check-all-inline-discussions").prop("checked")};e.preventDefault(),i.saveForm(i.$(".inline-discussion-topics"),n).done(function(){i.model.fetch().done(function(){i.render(),i.showMessage(t("Your changes have been saved."),i.$(".inline-discussion-topics"))}).fail(function(){var e=t("We've encountered an error. Refresh your browser and then try again.");i.showMessage(e,i.$(".inline-discussion-topics"),"error")})})}});return c})}.call(this,define||RequireJS.define),function(e){"use strict";RequireJS.define("js/discussions_management/views/divided_discussions_course_wide",["jquery","underscore","backbone","gettext","js/discussions_management/views/divided_discussions","edx-ui-toolkit/js/utils/html-utils"],function(e,i,s,t,n,o){var c=n.extend({events:{"change .check-discussion-subcategory-course-wide":"discussionCategoryStateChanged","click .cohort-course-wide-discussions-form .action-save":"saveCourseWideDiscussionsForm"},initialize:function(i){this.template=o.template(e("#divided-discussions-course-wide-tpl").text()),this.discussionSettings=i.discussionSettings},render:function(){o.setHtml(this.$(".course-wide-discussions-nav"),this.template({courseWideTopicsHtml:this.getCourseWideDiscussionsHtml(this.model.get("course_wide_discussions"))})),this.setDisabled(this.$(".cohort-course-wide-discussions-form .action-save"),!0)},getCourseWideDiscussionsHtml:function(s){var t=o.template(e("#cohort-discussions-subcategory-tpl").html()),n=s.entries,c=s.children;return o.joinHtml.apply(this,i.map(c,function(e){var i=e[0],s=n[i];return t({name:i,id:s.id,is_divided:s.is_divided,type:"course-wide"})}))},discussionCategoryStateChanged:function(e){e.preventDefault(),this.setDisabled(this.$(".cohort-course-wide-discussions-form .action-save"),!1)},saveCourseWideDiscussionsForm:function(e){var i=this,s=i.getDividedDiscussions(".check-discussion-subcategory-course-wide:checked"),n={divided_course_wide_discussions:s};e.preventDefault(),i.saveForm(i.$(".course-wide-discussion-topics"),n).done(function(){i.model.fetch().done(function(){i.render(),i.showMessage(t("Your changes have been saved."),i.$(".course-wide-discussion-topics"))}).fail(function(){var e=t("We've encountered an error. Refresh your browser and then try again.");i.showMessage(e,i.$(".course-wide-discussion-topics"),"error")})})}});return c})}.call(this,define||RequireJS.define),function(e){"use strict";RequireJS.define("js/views/base_dashboard_view",["jquery","backbone"],function(e,i){var s=i.View.extend({pubSub:e.extend({},i.Events)});return s})}.call(this,define||RequireJS.define),function(e){"use strict";RequireJS.define("js/discussions_management/views/discussions",["jquery","underscore","backbone","gettext","js/discussions_management/views/divided_discussions_inline","js/discussions_management/views/divided_discussions_course_wide","edx-ui-toolkit/js/utils/html-utils","edx-ui-toolkit/js/utils/string-utils","js/views/base_dashboard_view","js/models/notification","js/views/notification"],function(e,i,s,t,n,o,c,a,d){var r="hidden",u="two-column-layout",l="three-column-layout",h="cohort",m="none",v="enrollment_track",f=d.extend({events:{"click .division-scheme":"divisionSchemeChanged","change .cohorts-state":"onCohortsEnabledChanged"},initialize:function(i){this.template=c.template(e("#discussions-tpl").text()),this.context=i.context,this.discussionSettings=i.discussionSettings,this.listenTo(this.pubSub,"cohorts:state",this.cohortStateUpdate,this)},render:function(){var e=this.discussionSettings.attributes.available_division_schemes.length;return c.setHtml(this.$el,this.template({availableSchemes:this.getDivisionSchemeData(this.discussionSettings.attributes.division_scheme),layoutClass:2===e?l:u})),this.updateTopicVisibility(this.getSelectedScheme(),this.getTopicNav()),this.renderTopics(),(this.isSchemeAvailable(h)||!this.isSchemeAvailable(h)&&this.getSelectedScheme()===h)&&this.showCohortSchemeControl(!0),this},getDivisionSchemeData:function(e){return[{key:m,displayName:t("Not divided"),descriptiveText:t("Discussions are unified; all learners interact with posts from other learners, regardless of the group they are in."),selected:e===m,enabled:!0},{key:v,displayName:t("Enrollment Tracks"),descriptiveText:t("Use enrollment tracks as the basis for dividing discussions. All learners, regardless of their enrollment track, see the same discussion topics, but within divided topics, only learners who are in the same enrollment track see and respond to each others’ posts."),selected:e===v,enabled:this.isSchemeAvailable(v)||e===v},{key:h,displayName:t("Cohorts"),descriptiveText:t("Use cohorts as the basis for dividing discussions. All learners, regardless of cohort, see the same discussion topics, but within divided topics, only members of the same cohort see and respond to each others’ posts. "),selected:e===h,enabled:this.isSchemeAvailable(h)||e===h}]},isSchemeAvailable:function(e){return-1!==this.discussionSettings.attributes.available_division_schemes.indexOf(e)},showMessage:function(e,i){var s=new NotificationModel({type:i||"confirmation",title:e});this.removeNotification(),this.notification=new NotificationView({model:s}),this.$(".division-scheme-container").prepend(this.notification.$el),this.notification.render()},cohortStateUpdate:function(e){var i;e.is_cohorted&&!this.isSchemeAvailable(h)?this.discussionSettings.attributes.available_division_schemes.push(h):e.is_cohorted||this.getSelectedScheme()===h||(i=this.discussionSettings.attributes.available_division_schemes.indexOf(h),i>-1&&this.discussionSettings.attributes.available_division_schemes.splice(i,1)),this.isSchemeAvailable(v)||this.showDiscussionManagement(e.is_cohorted),this.getSelectedScheme()!==h&&this.showCohortSchemeControl(e.is_cohorted)},showDiscussionManagement:function(i){i?(e(".btn-link.discussions_management").removeClass(r),e("#discussions_management").removeClass(r)):(e(".btn-link.discussions_management").addClass(r),e("#discussions_management").addClass(r))},showCohortSchemeControl:function(i){i?(e(".division-scheme-item.cohort").removeClass(r),this.isSchemeAvailable(v)?e(".division-scheme-item").removeClass(u).addClass(l):e(".division-scheme-item").removeClass(l).addClass(u)):(e(".division-scheme-item.cohort").addClass(r),e(".division-scheme-item").removeClass(l).addClass(u))},removeNotification:function(){this.notification&&this.notification.remove()},getSelectedScheme:function(){return this.$('input[name="division-scheme"]:checked').val()},getTopicNav:function(){return this.$(".topic-division-nav")},divisionSchemeChanged:function(){var e=this.getSelectedScheme(),i=this.getTopicNav(),s={division_scheme:e};this.updateTopicVisibility(e,i),this.saveDivisionScheme(i,s,e)},saveDivisionScheme:function(e,i,s){var n,o=this,c=this.discussionSettings,d="";this.removeNotification(),n=function(e){o.showMessage(e,"error")},c.save(i,{patch:!0,wait:!0}).done(function(){switch(s){case m:d=t("Discussion topics in the course are not divided.");break;case v:d=t("Any divided discussion topics are divided based on enrollment track.");break;case h:d=t("Any divided discussion topics are divided based on cohort.")}o.showMessage(a.interpolate(t("Your changes have been saved. {details}"),{details:d},!0))}).fail(function(e){var i,s=null;try{i=JSON.parse(e.responseText),s=i.error}catch(o){}s||(s=t("We have encountered an error. Refresh your browser and then try again.")),n(s)})},updateTopicVisibility:function(e,i){e===m?i.addClass(r):i.removeClass(r)},getSectionCss:function(e){return".instructor-nav .nav-item [data-section='"+e+"']"},renderTopics:function(){var e=this.$(".discussions-nav");this.CourseWideDiscussionsView||(this.CourseWideDiscussionsView=new o({el:e,model:this.context.courseDiscussionTopicDetailsModel,discussionSettings:this.discussionSettings}).render()),this.InlineDiscussionsView||(this.InlineDiscussionsView=new n({el:e,model:this.context.courseDiscussionTopicDetailsModel,discussionSettings:this.discussionSettings}).render())}});return f})}.call(this,define||RequireJS.define),function(e){"use strict";RequireJS.define("js/discussions_management/models/course_discussions_detail",["backbone"],function(e){var i=e.Model.extend({defaults:{course_wide_discussions:{},inline_discussions:{}}});return i})}.call(this,define||RequireJS.define),function(e){"use strict";RequireJS.define("js/discussions_management/models/course_discussions_settings",["backbone"],function(e){var i=e.Model.extend({idAttribute:"id",defaults:{divided_inline_discussions:[],divided_course_wide_discussions:[],always_divide_inline_discussions:!1,division_scheme:"none"}});return i})}.call(this,define||RequireJS.define),function(e){"use strict";RequireJS.define("js/discussions_management/views/discussions_dashboard_factory",["jquery","js/discussions_management/views/discussions","js/discussions_management/models/course_discussions_detail","js/discussions_management/models/course_discussions_settings"],function(e,i,s,t){return function(){var n,o=new t,c=new s,a=e(".discussions-management");o.url=a.data("course-discussion-settings-url"),c.url=a.data("discussion-topics-url"),n=new i({el:a,discussionSettings:o,context:{courseDiscussionTopicDetailsModel:c}}),o.fetch().done(function(){c.fetch().done(function(){n.render()})})}})}.call(this,define||RequireJS.define);