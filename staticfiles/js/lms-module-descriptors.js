(function(){"use strict";var XModule={};XModule.Descriptor=function(){var Descriptor=function(element){this.element=element;this.update=_.bind(this.update,this)};Descriptor.prototype.onUpdate=function(callback){if(!this.callbacks){this.callbacks=[]}this.callbacks.push(callback)};Descriptor.prototype.update=function(){var data,callbacks,i,length;data=this.save();callbacks=this.callbacks;length=callbacks.length;$.each(callbacks,function(index,callback){callback(data)})};Descriptor.prototype.save=function(){return{}};return Descriptor}();this.XBlockToXModuleShim=function(runtime,element,initArgs){var moduleType,module;if(initArgs){moduleType=initArgs["xmodule-type"]}if(!moduleType){moduleType=$(element).data("type")}if(moduleType==="None"){return}try{module=new window[moduleType](element);if($(element).hasClass("xmodule_edit")){$(document).trigger("XModule.loaded.edit",[element,module])}if($(element).hasClass("xmodule_display")){$(document).trigger("XModule.loaded.display",[element,module])}return module}catch(error){console.error("Unable to load "+moduleType+": "+error.message)}};this.XModule=XModule}).call(this);(function(){"use strict";var hasPropsHelper={}.hasOwnProperty,extendsHelper=function(child,parent){var key;for(key in parent){if(hasPropsHelper.call(parent,key)){child[key]=parent[key]}}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};this.MarkdownEditingDescriptor=function(_super){extendsHelper(MarkdownEditingDescriptor,_super);MarkdownEditingDescriptor.multipleChoiceTemplate="( ) "+gettext("incorrect")+"\n( ) "+gettext("incorrect")+"\n(x) "+gettext("correct")+"\n";MarkdownEditingDescriptor.checkboxChoiceTemplate="[x] "+gettext("correct")+"\n[ ] incorrect\n[x] correct\n";MarkdownEditingDescriptor.stringInputTemplate="= "+gettext("answer")+"\n";MarkdownEditingDescriptor.numberInputTemplate="= "+gettext("answer")+" +- 0.001%\n";MarkdownEditingDescriptor.selectTemplate="[["+gettext("incorrect")+", ("+gettext("correct")+"), "+gettext("incorrect")+"]]\n";MarkdownEditingDescriptor.headerTemplate=""+gettext("Header")+"\n=====\n";MarkdownEditingDescriptor.explanationTemplate="[explanation]\n"+gettext("Short explanation")+"\n[explanation]\n";function MarkdownEditingDescriptor(element){var that=this;this.toggleCheatsheetVisibility=function(){return MarkdownEditingDescriptor.prototype.toggleCheatsheetVisibility.apply(that,arguments)};this.toggleCheatsheet=function(){return MarkdownEditingDescriptor.prototype.toggleCheatsheet.apply(that,arguments)};this.onToolbarButton=function(){return MarkdownEditingDescriptor.prototype.onToolbarButton.apply(that,arguments)};this.onShowXMLButton=function(){return MarkdownEditingDescriptor.prototype.onShowXMLButton.apply(that,arguments)};this.element=element;if($(".markdown-box",this.element).length!==0){this.markdown_editor=CodeMirror.fromTextArea($(".markdown-box",element)[0],{lineWrapping:true,mode:null});this.setCurrentEditor(this.markdown_editor);this.element.on("click",".xml-tab",this.onShowXMLButton);this.element.on("click",".format-buttons button",this.onToolbarButton);this.element.on("click",".cheatsheet-toggle",this.toggleCheatsheet);$(this.element.find(".xml-box")).hide()}else{this.createXMLEditor()}}MarkdownEditingDescriptor.prototype.createXMLEditor=function(text){this.xml_editor=CodeMirror.fromTextArea($(".xml-box",this.element)[0],{mode:"xml",lineNumbers:true,lineWrapping:true});if(text){this.xml_editor.setValue(text)}this.setCurrentEditor(this.xml_editor);$(this.xml_editor.getWrapperElement()).toggleClass("CodeMirror-advanced");this.xml_editor.refresh()};MarkdownEditingDescriptor.prototype.onShowXMLButton=function(e){e.preventDefault();if(this.cheatsheet&&this.cheatsheet.hasClass("shown")){this.cheatsheet.toggleClass("shown");this.toggleCheatsheetVisibility()}if(this.confirmConversionToXml()){this.createXMLEditor(MarkdownEditingDescriptor.markdownToXml(this.markdown_editor.getValue()));this.xml_editor.setCursor(0);$(this.element.find(".editor-bar")).hide()}};MarkdownEditingDescriptor.prototype.confirmConversionToXml=function(){return confirm(gettext("If you use the Advanced Editor, this problem will be converted to XML and you will not be able to return to the Simple Editor Interface.\n\nProceed to the Advanced Editor and convert this problem to XML?"))};MarkdownEditingDescriptor.prototype.onToolbarButton=function(e){var revisedSelection,selection;e.preventDefault();selection=this.markdown_editor.getSelection();revisedSelection=null;switch($(e.currentTarget).attr("class")){case"multiple-choice-button":revisedSelection=MarkdownEditingDescriptor.insertMultipleChoice(selection);break;case"string-button":revisedSelection=MarkdownEditingDescriptor.insertStringInput(selection);break;case"number-button":revisedSelection=MarkdownEditingDescriptor.insertNumberInput(selection);break;case"checks-button":revisedSelection=MarkdownEditingDescriptor.insertCheckboxChoice(selection);break;case"dropdown-button":revisedSelection=MarkdownEditingDescriptor.insertSelect(selection);break;case"header-button":revisedSelection=MarkdownEditingDescriptor.insertHeader(selection);break;case"explanation-button":revisedSelection=MarkdownEditingDescriptor.insertExplanation(selection);break;default:break}if(revisedSelection!==null){this.markdown_editor.replaceSelection(revisedSelection);this.markdown_editor.focus()}};MarkdownEditingDescriptor.prototype.toggleCheatsheet=function(e){var that=this;e.preventDefault();if(!$(this.markdown_editor.getWrapperElement()).find(".simple-editor-cheatsheet")[0]){this.cheatsheet=$($("#simple-editor-cheatsheet").html());$(this.markdown_editor.getWrapperElement()).append(this.cheatsheet)}this.toggleCheatsheetVisibility();return setTimeout(function(){return that.cheatsheet.toggleClass("shown")},10)};MarkdownEditingDescriptor.prototype.toggleCheatsheetVisibility=function(){return $(".modal-content").toggleClass("cheatsheet-is-shown")};MarkdownEditingDescriptor.prototype.setCurrentEditor=function(editor){if(this.current_editor){$(this.current_editor.getWrapperElement()).hide()}this.current_editor=editor;$(this.current_editor.getWrapperElement()).show();return $(this.current_editor).focus()};MarkdownEditingDescriptor.prototype.save=function(){this.element.off("click",".xml-tab",this.changeEditor);this.element.off("click",".format-buttons button",this.onToolbarButton);this.element.off("click",".cheatsheet-toggle",this.toggleCheatsheet);if(this.current_editor===this.markdown_editor){return{data:MarkdownEditingDescriptor.markdownToXml(this.markdown_editor.getValue()),metadata:{markdown:this.markdown_editor.getValue()}}}else{return{data:this.xml_editor.getValue(),nullout:["markdown"]}}};MarkdownEditingDescriptor.insertMultipleChoice=function(selectedText){return MarkdownEditingDescriptor.insertGenericChoice(selectedText,"(",")",MarkdownEditingDescriptor.multipleChoiceTemplate)};MarkdownEditingDescriptor.insertCheckboxChoice=function(selectedText){return MarkdownEditingDescriptor.insertGenericChoice(selectedText,"[","]",MarkdownEditingDescriptor.checkboxChoiceTemplate)};MarkdownEditingDescriptor.insertGenericChoice=function(selectedText,choiceStart,choiceEnd,template){var cleanSelectedText,line,lines,revisedLines,i,len;if(selectedText.length>0){cleanSelectedText=selectedText.replace(/\n+/g,"\n").replace(/\n$/,"");lines=cleanSelectedText.split("\n");revisedLines="";for(i=0,len=lines.length;i<len;i++){line=lines[i];revisedLines+=choiceStart;if(/^\s*x\s+(\S)/i.test(line)){line=line.replace(/^\s*x\s+(\S)/i,"$1");revisedLines+="x"}else{revisedLines+=" "}revisedLines+=choiceEnd+" "+line+"\n"}return revisedLines}else{return template}};MarkdownEditingDescriptor.insertStringInput=function(selectedText){return MarkdownEditingDescriptor.insertGenericInput(selectedText,"= ","",MarkdownEditingDescriptor.stringInputTemplate)};MarkdownEditingDescriptor.insertNumberInput=function(selectedText){return MarkdownEditingDescriptor.insertGenericInput(selectedText,"= ","",MarkdownEditingDescriptor.numberInputTemplate)};MarkdownEditingDescriptor.insertSelect=function(selectedText){return MarkdownEditingDescriptor.insertGenericInput(selectedText,"[[","]]",MarkdownEditingDescriptor.selectTemplate)};MarkdownEditingDescriptor.insertHeader=function(selectedText){return MarkdownEditingDescriptor.insertGenericInput(selectedText,"","\n====\n",MarkdownEditingDescriptor.headerTemplate)};MarkdownEditingDescriptor.insertExplanation=function(selectedText){return MarkdownEditingDescriptor.insertGenericInput(selectedText,"[explanation]\n","\n[explanation]",MarkdownEditingDescriptor.explanationTemplate)};MarkdownEditingDescriptor.insertGenericInput=function(selectedText,lineStart,lineEnd,template){if(selectedText.length>0){return lineStart+selectedText+lineEnd}else{return template}};MarkdownEditingDescriptor.markdownToXml=function(markdown){var demandHintTags=[],finalDemandHints,finalXml,responseTypesMarkdown,responseTypesXML,toXml;toXml=function(partialMarkdown){var xml=partialMarkdown,i,splits,makeParagraph,serializer,responseType,$xml,responseTypesSelector,inputtype,beforeInputtype,extractHint,demandhints;var responseTypes=["optionresponse","multiplechoiceresponse","stringresponse","numericalresponse","choiceresponse"];xml=xml.replace(/\r\n/g,"\n");xml=xml.replace(/(^.*?$)(?=\n\=\=+$)/gm,'<h3 class="hd hd-2 problem-header">$1</h3>');xml=xml.replace(/\n^\=\=+$/gm,"");xml=xml.replace(/>>([^]+?)<</gm,function(match,questionText){var result=questionText.split("||"),label="<label>"+result[0]+"</label>\n";if(result.length===1||!result[1]){return label}return label+"<description>"+result[1]+"</description>\n"});demandhints="";xml=xml.replace(/(^\s*\|\|.*?\|\|\s*$\n?)+/gm,function(match){var inner,options=match.split("\n");for(i=0;i<options.length;i+=1){inner=/\s*\|\|(.*?)\|\|/.exec(options[i]);if(inner){demandhints+="  <hint>"+inner[1].trim()+"</hint>\n"}}return""});xml=xml.replace(/{{(.|\n)*?}}/gm,function(match){return match.replace(/\r?\n( |\t)*/g," ")});extractHint=function(inputText,detectParens){var text=inputText,curly=/\s*{{(.*?)}}/.exec(text),hint="",label="",parens=false,labelassign="",labelmatch;if(curly){text=text.replace(curly[0],"");hint=curly[1].trim();labelmatch=/^(.*?)::/.exec(hint);if(labelmatch){hint=hint.replace(labelmatch[0],"").trim();label=labelmatch[1].trim();labelassign=' label="'+label+'"'}}if(detectParens){if(text.length>=2&&text[0]==="("&&text[text.length-1]===")"){text=text.substring(1,text.length-1);parens=true}}return{nothint:text,hint:hint,label:label,parens:parens,labelassign:labelassign}};xml=xml.replace(/\[\[((.|\n)+?)\]\]/g,function(match,group1){var textHint,options,optiontag,correct,lines,optionlines,line,correctstr,hintstr,label;if(match.indexOf("\n")===-1){options=group1.split(/\,\s*/g);optiontag='  <optioninput options="(';for(i=0;i<options.length;i+=1){optiontag+="'"+options[i].replace(/(?:^|,)\s*\((.*?)\)\s*(?:$|,)/g,"$1")+"'"+(i<options.length-1?",":"")}optiontag+=')" correct="';correct=/(?:^|,)\s*\((.*?)\)\s*(?:$|,)/g.exec(group1);if(correct){optiontag+=correct[1]}optiontag+='">';return"\n<optionresponse>\n"+optiontag+"</optioninput>\n</optionresponse>\n\n"}lines=group1.split("\n");optionlines="";for(i=0;i<lines.length;i++){line=lines[i].trim();if(line.length>0){textHint=extractHint(line,true);correctstr=' correct="'+(textHint.parens?"True":"False")+'"';hintstr="";if(textHint.hint){label=textHint.label;if(label){label=' label="'+label+'"'}hintstr=" <optionhint"+label+">"+textHint.hint+"</optionhint>"}optionlines+="    <option"+correctstr+">"+textHint.nothint+hintstr+"</option>\n"}}return"\n<optionresponse>\n  <optioninput>\n"+optionlines+"  </optioninput>\n</optionresponse>\n\n"});xml=xml.replace(/(^\s*\(.{0,3}\).*?$\n*)+/gm,function(match){var choices="",shuffle=false,options=match.split("\n"),value,inparens,correct,fixed,hint,result;for(i=0;i<options.length;i++){options[i]=options[i].trim();if(options[i].length>0){value=options[i].split(/^\s*\(.{0,3}\)\s*/)[1];inparens=/^\s*\((.{0,3})\)\s*/.exec(options[i])[1];correct=/x/i.test(inparens);fixed="";if(/@/.test(inparens)){fixed=' fixed="true"'}if(/!/.test(inparens)){shuffle=true}hint=extractHint(value);if(hint.hint){value=hint.nothint;value=value+" <choicehint"+hint.labelassign+">"+hint.hint+"</choicehint>"}choices+='    <choice correct="'+correct+'"'+fixed+">"+value+"</choice>\n"}}result="<multiplechoiceresponse>\n";if(shuffle){result+='  <choicegroup type="MultipleChoice" shuffle="true">\n'}else{result+='  <choicegroup type="MultipleChoice">\n'}result+=choices;result+="  </choicegroup>\n";result+="</multiplechoiceresponse>\n\n";return result});xml=xml.replace(/(^\s*((\[.?\])|({{.*?}})).*?$\n*)+/gm,function(match){var groupString="<choiceresponse>\n",options=match.split("\n"),value,correct,abhint,endHints,hintbody,hint,inner,select,hints;groupString+="  <checkboxgroup>\n";endHints="";for(i=0;i<options.length;i+=1){if(options[i].trim().length>0){abhint=/^\s*{{\s*\(\((.*?)\)\)(.*?)}}/.exec(options[i]);if(abhint){hintbody=abhint[2];hintbody=hintbody.replace("&lf;","\n").trim();endHints+='    <compoundhint value="'+abhint[1].trim()+'">'+hintbody+"</compoundhint>\n";continue}value=options[i].split(/^\s*\[.?\]\s*/)[1];correct=/^\s*\[x\]/i.test(options[i]);hints="";hint=extractHint(value);if(hint.hint){inner="{"+hint.hint+"}";select=/{\s*(s|selected):((.|\n)*?)}/i.exec(inner);if(select){hints+='\n      <choicehint selected="true">'+select[2].trim()+"</choicehint>"}select=/{\s*(u|unselected):((.|\n)*?)}/i.exec(inner);if(select){hints+='\n      <choicehint selected="false">'+select[2].trim()+"</choicehint>"}if(hints){value=hint.nothint}}groupString+='    <choice correct="'+correct+'">'+value+hints+"</choice>\n"}}groupString+=endHints;groupString+="  </checkboxgroup>\n";groupString+="</choiceresponse>\n\n";return groupString});xml=xml.replace(/(^s?\=\s*(.*?$)(\n*(or|not)\=\s*(.*?$))*)+/gm,function(match,p){var answersList=p.split("\n"),isRangeToleranceCase=function(answer){return _.contains(["[","("],answer[0])&&_.contains(["]",")"],answer[answer.length-1])},getAnswerData=function(answerValue){var answerData={},answerParams=/(.*?)\+\-\s*(.*?$)/.exec(answerValue);if(answerParams){answerData.answer=answerParams[1].replace(/\s+/g,"");answerData.default=answerParams[2]}else{answerData.answer=answerValue.replace(/\s+/g,"")}return answerData},processNumericalResponse=function(answerValues){var firstAnswer,answerData,numericalResponseString,additionalAnswerString,textHint,hintLine,additionalTextHint,additionalHintLine,orMatch,hasTolerance;firstAnswer=answerValues[0].replace(/^\=\s*/,"");if(isNaN(parseFloat(firstAnswer))&&!isRangeToleranceCase(firstAnswer)){return false}textHint=extractHint(firstAnswer);hintLine="";if(textHint.hint){firstAnswer=textHint.nothint;hintLine="  <correcthint"+textHint.labelassign+">"+textHint.hint+"</correcthint>\n"}if(isRangeToleranceCase(firstAnswer)){numericalResponseString='<numericalresponse answer="'+firstAnswer+'">\n'}else{answerData=getAnswerData(firstAnswer);numericalResponseString='<numericalresponse answer="'+answerData.answer+'">\n';if(answerData.default){numericalResponseString+='  <responseparam type="tolerance" default="'+answerData.default+'" />\n'}}additionalAnswerString="";for(i=1;i<answerValues.length;i++){additionalHintLine="";additionalTextHint=extractHint(answerValues[i]);orMatch=/^or\=\s*(.*)/.exec(additionalTextHint.nothint);if(orMatch){hasTolerance=/(.*?)\+\-\s*(.*?$)/.exec(orMatch[1]);if(isNaN(parseFloat(orMatch[1]))||isRangeToleranceCase(orMatch[1])||hasTolerance){continue}if(additionalTextHint.hint){additionalHintLine="<correcthint"+additionalTextHint.labelassign+">"+additionalTextHint.hint+"</correcthint>"}additionalAnswerString+='  <additional_answer answer="'+orMatch[1]+'">';additionalAnswerString+=additionalHintLine;additionalAnswerString+="</additional_answer>\n"}}if(additionalAnswerString){numericalResponseString+=additionalAnswerString}numericalResponseString+="  <formulaequationinput />\n";numericalResponseString+=hintLine;numericalResponseString+="</numericalresponse>\n\n";return numericalResponseString},processStringResponse=function(values){var firstAnswer,textHint,typ,string,orMatch,notMatch;firstAnswer=values.shift();firstAnswer=firstAnswer.replace(/^s?\=\s*/,"");textHint=extractHint(firstAnswer);firstAnswer=textHint.nothint;typ=' type="ci"';if(firstAnswer[0]==="|"){typ=' type="ci regexp"';firstAnswer=firstAnswer.slice(1).trim()}string='<stringresponse answer="'+firstAnswer+'"'+typ+" >\n";if(textHint.hint){string+="  <correcthint"+textHint.labelassign+">"+textHint.hint+"</correcthint>\n"}for(i=0;i<values.length;i+=1){textHint=extractHint(values[i]);notMatch=/^not\=\s*(.*)/.exec(textHint.nothint);if(notMatch){string+='  <stringequalhint answer="'+notMatch[1]+'"'+textHint.labelassign+">"+textHint.hint+"</stringequalhint>\n";continue}orMatch=/^or\=\s*(.*)/.exec(textHint.nothint);if(orMatch){string+='  <additional_answer answer="'+orMatch[1]+'">';if(textHint.hint){string+="<correcthint"+textHint.labelassign+">"+textHint.hint+"</correcthint>"}string+="</additional_answer>\n"}}string+='  <textline size="20"/>\n</stringresponse>\n\n';return string};return processNumericalResponse(answersList)||processStringResponse(answersList)});xml=xml.replace(/\[explanation\]\n?([^\]]*)\[\/?explanation\]/gim,function(match,p1){return'<solution>\n<div class="detailed-solution">\n'+gettext("Explanation")+"\n\n"+p1+"\n</div>\n</solution>"});xml=xml.replace(/\[code\]\n?([^\]]*)\[\/?code\]/gim,function(match,p1){return"<pre><code>"+p1+"</code></pre>"});splits=xml.split(/(\<\/?(?:script|pre|label|description).*?\>)/g);makeParagraph=true;for(i=0;i<splits.length;i+=1){if(/\<(script|pre|label|description)/.test(splits[i])){makeParagraph=false}if(makeParagraph){splits[i]=splits[i].replace(/(^(?!\s*\<|$).*$)/gm,"<p>$1</p>")}if(/\<\/(script|pre|label|description)/.test(splits[i])){makeParagraph=true}}xml=splits.join("");xml=xml.replace(/\n\n\n/g,"\n");if(demandhints){demandHintTags.push(demandhints)}responseTypesSelector=responseTypes.join(", ");$xml=$($.parseXML("<prob>"+xml+"</prob>"));responseType=$xml.find(responseTypesSelector);if(responseType.length===1){inputtype=responseType[0].firstElementChild;beforeInputtype=true;_.each($xml.find("prob").children(),function(child){if(responseType[0].nodeName===child.nodeName){beforeInputtype=false;return}if(beforeInputtype){responseType[0].insertBefore(child,inputtype)}else{responseType[0].appendChild(child)}});serializer=new XMLSerializer;xml=serializer.serializeToString(responseType[0]);xml=xml.replace(/\sxmlns=['"].*?['"]/gi,"");xml=xml.replace(/(\<\/.*?\>)(\<.*?\>)/gi,"$1\n$2")}xml=xml.replace(/\sclass=\'qtitle\'/gi,"");return xml};responseTypesXML=[];responseTypesMarkdown=markdown.split(/\n\s*---\s*\n/g);_.each(responseTypesMarkdown,function(responseTypeMarkdown){if(responseTypeMarkdown.trim().length>0){responseTypesXML.push(toXml(responseTypeMarkdown))}});finalDemandHints="";if(demandHintTags.length){finalDemandHints="\n<demandhint>\n"+demandHintTags.join("")+"</demandhint>"}finalXml="<problem>\n"+responseTypesXML.join("\n\n")+finalDemandHints+"\n</problem>";return finalXml};return MarkdownEditingDescriptor}(XModule.Descriptor)}).call(this);(function(){var extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},hasProp={}.hasOwnProperty;this.VerticalDescriptor=function(superClass){extend(VerticalDescriptor,superClass);function VerticalDescriptor(){return VerticalDescriptor.__super__.constructor.apply(this,arguments)}return VerticalDescriptor}(XModule.Descriptor)}).call(this);(function(){var extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},hasProp={}.hasOwnProperty;this.MetadataOnlyEditingDescriptor=function(superClass){extend(MetadataOnlyEditingDescriptor,superClass);function MetadataOnlyEditingDescriptor(element){this.element=element}MetadataOnlyEditingDescriptor.prototype.save=function(){return{data:null}};return MetadataOnlyEditingDescriptor}(XModule.Descriptor)}).call(this);(function(){var bind=function(fn,me){return function(){return fn.apply(me,arguments)}};this.HTMLEditingDescriptor=function(){var CUSTOM_FONTS,STANDARD_FONTS,_getFonts;CUSTOM_FONTS="Default='Open Sans', Verdana, Arial, Helvetica, sans-serif;";STANDARD_FONTS="Andale Mono=andale mono,times;"+"Arial=arial,helvetica,sans-serif;"+"Arial Black=arial black,avant garde;"+"Book Antiqua=book antiqua,palatino;"+"Comic Sans MS=comic sans ms,sans-serif;"+"Courier New=courier new,courier;"+"Georgia=georgia,palatino;"+"Helvetica=helvetica;"+"Impact=impact,chicago;"+"Symbol=symbol;"+"Tahoma=tahoma,arial,helvetica,sans-serif;"+"Terminal=terminal,monaco;"+"Times New Roman=times new roman,times;"+"Trebuchet MS=trebuchet ms,geneva;"+"Verdana=verdana,geneva;"+"Webdings=webdings;"+"Wingdings=wingdings,zapf dingbats";_getFonts=function(){return CUSTOM_FONTS+STANDARD_FONTS};function HTMLEditingDescriptor(element){this.initInstanceCallback=bind(this.initInstanceCallback,this);this.saveCodeEditor=bind(this.saveCodeEditor,this);this.showCodeEditor=bind(this.showCodeEditor,this);this.saveLink=bind(this.saveLink,this);this.editLink=bind(this.editLink,this);this.editImageSubmit=bind(this.editImageSubmit,this);this.saveImageFromModal=bind(this.saveImageFromModal,this);this.closeImageModal=bind(this.closeImageModal,this);this.openImageModal=bind(this.openImageModal,this);this.saveImage=bind(this.saveImage,this);this.editImage=bind(this.editImage,this);this.setupTinyMCE=bind(this.setupTinyMCE,this);var tiny_mce_css_links;this.element=element;this.base_asset_url=this.element.find("#editor-tab").data("base-asset-url");this.editor_choice=this.element.find("#editor-tab").data("editor");this.new_image_modal=window.STUDIO_FRONTEND_IN_CONTEXT_IMAGE_SELECTION;if(this.base_asset_url===void 0){this.base_asset_url=null}this.advanced_editor=CodeMirror.fromTextArea($(".edit-box",this.element)[0],{mode:"text/html",lineNumbers:true,lineWrapping:true});if(this.editor_choice==="visual"){this.$advancedEditorWrapper=$(this.advanced_editor.getWrapperElement());this.$advancedEditorWrapper.addClass("is-inactive");tiny_mce_css_links=[];$("link[rel=stylesheet][href*='tinymce']").filter("[href*='content']").each(function(){tiny_mce_css_links.push($(this).attr("href"))});tinyMCE.baseURL=baseUrl+"/js/vendor/tinymce/js/tinymce";tinyMCE.suffix=".min";this.tiny_mce_textarea=$(".tiny-mce",this.element).tinymce({script_url:baseUrl+"/js/vendor/tinymce/js/tinymce/tinymce.full.min.js",font_formats:_getFonts(),theme:"modern",skin:"studio-tmce4",schema:"html5",convert_urls:false,directionality:$(".wrapper-view, .window-wrap").prop("dir"),content_css:tiny_mce_css_links.join(", "),formats:{code:{inline:"code"}},visual:false,plugins:"textcolor, link, image, codemirror",codemirror:{path:baseUrl+"/js/vendor"},image_advtab:true,toolbar:"formatselect | fontselect | bold italic underline forecolor wrapAsCode | "+"alignleft aligncenter alignright alignjustify | "+"bullist numlist outdent indent blockquote | link unlink "+((this.new_image_modal?"insertImage":"image")+" | code"),block_formats:interpolate("%(paragraph)s=p;%(preformatted)s=pre;%(heading3)s=h3;%(heading4)s=h4;%(heading5)s=h5;%(heading6)s=h6",{paragraph:gettext("Paragraph"),preformatted:gettext("Preformatted"),heading3:gettext("Heading 3"),heading4:gettext("Heading 4"),heading5:gettext("Heading 5"),heading6:gettext("Heading 6")},true),width:"100%",height:"400px",menubar:false,statusbar:false,valid_children:"+body[style]",valid_elements:"*[*]",extended_valid_elements:"*[*]",invalid_elements:"",setup:this.setupTinyMCE,init_instance_callback:this.initInstanceCallback,browser_spellcheck:true});tinymce.addI18n("en",{"Add to Dictionary":gettext("Add to Dictionary"),Advanced:gettext("Advanced"),"Align center":gettext("Align center"),"Align left":gettext("Align left"),"Align right":gettext("Align right"),Alignment:gettext("Alignment"),"Alternative source":gettext("Alternative source"),Anchor:gettext("Anchor"),Anchors:gettext("Anchors"),Author:gettext("Author"),"Background color":gettext("Background color"),Blockquote:gettext("Blockquote"),Blocks:gettext("Blocks"),Body:gettext("Body"),Bold:gettext("Bold"),"Border color":gettext("Border color"),Border:gettext("Border"),Bottom:gettext("Bottom"),"Bullet list":gettext("Bullet list"),Cancel:gettext("Cancel"),Caption:gettext("Caption"),"Cell padding":gettext("Cell padding"),"Cell properties":gettext("Cell properties"),"Cell spacing":gettext("Cell spacing"),"Cell type":gettext("Cell type"),Cell:gettext("Cell"),Center:gettext("Center"),Circle:gettext("Circle"),"Clear formatting":gettext("Clear formatting"),Close:gettext("Close"),"Code block":gettext("Code block"),Code:gettext("Code"),Color:gettext("Color"),Cols:gettext("Cols"),"Column group":gettext("Column group"),Column:gettext("Column"),"Constrain proportions":gettext("Constrain proportions"),"Copy row":gettext("Copy row"),Copy:gettext("Copy"),"Could not find the specified string.":gettext("Could not find the specified string."),"Custom color":gettext("Custom color"),"Custom...":gettext("Custom..."),"Cut row":gettext("Cut row"),Cut:gettext("Cut"),"Decrease indent":gettext("Decrease indent"),Default:gettext("Default"),"Delete column":gettext("Delete column"),"Delete row":gettext("Delete row"),"Delete table":gettext("Delete table"),Description:gettext("Description"),Dimensions:gettext("Dimensions"),Disc:gettext("Disc"),Div:gettext("Div"),"Document properties":gettext("Document properties"),"Edit HTML":gettext("Edit HTML"),Edit:gettext("Edit"),Embed:gettext("Embed"),Emoticons:gettext("Emoticons"),Encoding:gettext("Encoding"),File:gettext("File"),"Find and replace":gettext("Find and replace"),"Find next":gettext("Find next"),"Find previous":gettext("Find previous"),Find:gettext("Find"),Finish:gettext("Finish"),"Font Family":gettext("Font Family"),"Font Sizes":gettext("Font Sizes"),Footer:gettext("Footer"),Format:gettext("Format"),Formats:gettext("Formats"),Fullscreen:gettext("Fullscreen"),General:gettext("General"),"H Align":gettext("H Align"),"Header 1":gettext("Header 1"),"Header 2":gettext("Header 2"),"Header 3":gettext("Header 3"),"Header 4":gettext("Header 4"),"Header 5":gettext("Header 5"),"Header 6":gettext("Header 6"),"Header cell":gettext("Header cell"),Header:gettext("Header"),Headers:gettext("Headers"),"Heading 1":gettext("Heading 1"),"Heading 2":gettext("Heading 2"),"Heading 3":gettext("Heading 3"),"Heading 4":gettext("Heading 4"),"Heading 5":gettext("Heading 5"),"Heading 6":gettext("Heading 6"),Headings:gettext("Headings"),Height:gettext("Height"),"Horizontal line":gettext("Horizontal line"),"Horizontal space":gettext("Horizontal space"),"HTML source code":gettext("HTML source code"),"Ignore all":gettext("Ignore all"),Ignore:gettext("Ignore"),"Image description":gettext("Image description"),"Increase indent":gettext("Increase indent"),Inline:gettext("Inline"),"Insert column after":gettext("Insert column after"),"Insert column before":gettext("Insert column before"),"Insert date/time":gettext("Insert date/time"),"Insert image":gettext("Insert image"),"Insert link":gettext("Insert link"),"Insert row after":gettext("Insert row after"),"Insert row before":gettext("Insert row before"),"Insert table":gettext("Insert table"),"Insert template":gettext("Insert template"),"Insert video":gettext("Insert video"),Insert:gettext("Insert"),"Insert/edit image":gettext("Insert/edit image"),"Insert/edit link":gettext("Insert/edit link"),"Insert/edit video":gettext("Insert/edit video"),Italic:gettext("Italic"),Justify:gettext("Justify"),Keywords:gettext("Keywords"),"Left to right":gettext("Left to right"),Left:gettext("Left"),"Lower Alpha":gettext("Lower Alpha"),"Lower Greek":gettext("Lower Greek"),"Lower Roman":gettext("Lower Roman"),"Match case":gettext("Match case"),"Merge cells":gettext("Merge cells"),Middle:gettext("Middle"),Name:gettext("Name"),"New document":gettext("New document"),"New window":gettext("New window"),Next:gettext("Next"),"No color":gettext("No color"),"Nonbreaking space":gettext("Nonbreaking space"),None:gettext("None"),"Numbered list":gettext("Numbered list"),Ok:gettext("Ok"),OK:gettext("OK"),"Page break":gettext("Page break"),Paragraph:gettext("Paragraph"),"Paste as text":gettext("Paste as text"),"Paste is now in plain text mode. Contents will now be pasted as plain text until you toggle this option off.":gettext("Paste is now in plain text mode. Contents will now be pasted as plain text until you toggle this option off."),"Paste row after":gettext("Paste row after"),"Paste row before":gettext("Paste row before"),"Paste your embed code below:":gettext("Paste your embed code below:"),Paste:gettext("Paste"),Poster:gettext("Poster"),Pre:gettext("Pre"),Prev:gettext("Prev"),Preview:gettext("Preview"),Print:gettext("Print"),Redo:gettext("Redo"),"Remove link":gettext("Remove link"),"Replace all":gettext("Replace all"),"Replace all":gettext("Replace all"),"Replace with":gettext("Replace with"),Replace:gettext("Replace"),Replace:gettext("Replace"),"Restore last draft":gettext("Restore last draft"),"Rich Text Area. Press ALT-F9 for menu. Press ALT-F10 for toolbar. Press ALT-0 for help":gettext("Rich Text Area. Press ALT-F9 for menu. Press ALT-F10 for toolbar. Press ALT-0 for help"),"Right to left":gettext("Right to left"),Right:gettext("Right"),Robots:gettext("Robots"),"Row group":gettext("Row group"),"Row properties":gettext("Row properties"),"Row type":gettext("Row type"),Row:gettext("Row"),Rows:gettext("Rows"),Save:gettext("Save"),Scope:gettext("Scope"),"Select all":gettext("Select all"),"Show blocks":gettext("Show blocks"),"Show invisible characters":gettext("Show invisible characters"),"Source code":gettext("Source code"),Source:gettext("Source"),"Special character":gettext("Special character"),Spellcheck:gettext("Spellcheck"),"Split cell":gettext("Split cell"),Square:gettext("Square"),"Start search":gettext("Start search"),Strikethrough:gettext("Strikethrough"),Style:gettext("Style"),Subscript:gettext("Subscript"),Superscript:gettext("Superscript"),"Table properties":gettext("Table properties"),Table:gettext("Table"),Target:gettext("Target"),Templates:gettext("Templates"),"Text color":gettext("Text color"),"Text to display":gettext("Text to display"),"The URL you entered seems to be an email address. Do you want to add the required mailto: prefix?":gettext("The URL you entered seems to be an email address. Do you want to add the required mailto: prefix?"),"The URL you entered seems to be an external link. Do you want to add the required http:// prefix?":gettext("The URL you entered seems to be an external link. Do you want to add the required http:// prefix?"),Title:gettext("Title"),Tools:gettext("Tools"),Top:gettext("Top"),Underline:gettext("Underline"),Undo:gettext("Undo"),"Upper Alpha":gettext("Upper Alpha"),"Upper Roman":gettext("Upper Roman"),Url:gettext("Url"),"V Align":gettext("V Align"),"Vertical space":gettext("Vertical space"),View:gettext("View"),"Visual aids":gettext("Visual aids"),"Whole words":gettext("Whole words"),Width:gettext("Width"),"Words: {0}":gettext("Words: {0}"),"You have unsaved changes are you sure you want to navigate away?":gettext("You have unsaved changes are you sure you want to navigate away?"),"Your browser doesn't support direct access to the clipboard. Please use the Ctrl+X/C/V keyboard shortcuts instead.":gettext("Your browser doesn't support direct access to the clipboard. Please use the Ctrl+X/C/V keyboard shortcuts instead.")})}}HTMLEditingDescriptor.prototype.setupTinyMCE=function(ed){ed.addButton("wrapAsCode",{title:gettext("Code block"),image:baseUrl+"/images/ico-tinymce-code.png",
onclick:function(){return ed.formatter.toggle("code")}});ed.addButton("insertImage",{title:gettext("Insert/Edit Image"),icon:"image",onclick:this.openImageModal});this.visualEditor=ed;this.imageModal=$("#edit-image-modal #modalWrapper");ed.on("SaveImage",this.saveImage);ed.on("EditImage",this.editImage);ed.on("SaveLink",this.saveLink);ed.on("EditLink",this.editLink);ed.on("ShowCodeEditor",this.showCodeEditor);ed.on("SaveCodeEditor",this.saveCodeEditor);this.imageModal.on("closeModal",this.closeImageModal);return this.imageModal.on("submitForm",this.editImageSubmit)};HTMLEditingDescriptor.prototype.editImage=function(data){if(data["src"]){return data["src"]=rewriteStaticLinks(data["src"],this.base_asset_url,"/static/")}};HTMLEditingDescriptor.prototype.saveImage=function(data){if(data["src"]){return data["src"]=rewriteStaticLinks(data["src"],"/static/",this.base_asset_url)}};HTMLEditingDescriptor.prototype.openImageModal=function(){var img,imgAttrs;img=$(this.visualEditor.selection.getNode());imgAttrs={baseAssetUrl:this.base_asset_url};if(img&&img.is("img")){imgAttrs["src"]=rewriteStaticLinks(img.attr("src"),this.base_asset_url,"/static/");imgAttrs["alt"]=img.attr("alt");imgAttrs["width"]=parseInt(img.attr("width"),10)||img[0].naturalWidth;imgAttrs["height"]=parseInt(img.attr("height"),10)||img[0].naturalHeight;imgAttrs["style"]=img.attr("style")}$("body").addClass("modal-open");return this.imageModal[0].dispatchEvent(new CustomEvent("openModal",{bubbles:true,detail:imgAttrs}))};HTMLEditingDescriptor.prototype.closeImageModal=function(){$("body").removeClass("modal-open")};HTMLEditingDescriptor.prototype.saveImageFromModal=function(data){if(data["src"]){data["src"]=rewriteStaticLinks(data["src"],"/static/",this.base_asset_url)}return this.visualEditor.insertContent(this.visualEditor.dom.createHTML("img",data))};HTMLEditingDescriptor.prototype.editImageSubmit=function(event){if(event.detail){this.saveImageFromModal(event.detail)}return this.closeImageModal()};HTMLEditingDescriptor.prototype.editLink=function(data){if(data["href"]){return data["href"]=rewriteStaticLinks(data["href"],this.base_asset_url,"/static/")}};HTMLEditingDescriptor.prototype.saveLink=function(data){if(data["href"]){return data["href"]=rewriteStaticLinks(data["href"],"/static/",this.base_asset_url)}};HTMLEditingDescriptor.prototype.showCodeEditor=function(source){var content;content=rewriteStaticLinks(source.content,this.base_asset_url,"/static/");return source.content=content};HTMLEditingDescriptor.prototype.saveCodeEditor=function(source){var content;content=rewriteStaticLinks(source.content,"/static/",this.base_asset_url);return source.content=content};HTMLEditingDescriptor.prototype.initInstanceCallback=function(visualEditor){visualEditor.setContent(rewriteStaticLinks(visualEditor.getContent({no_events:1}),"/static/",this.base_asset_url));this.starting_content=visualEditor.getContent({format:"raw",no_events:1});return visualEditor.focus()};HTMLEditingDescriptor.prototype.getVisualEditor=function(){return this.visualEditor};HTMLEditingDescriptor.prototype.save=function(){var raw_content,text,visualEditor;text=void 0;if(this.editor_choice==="visual"){visualEditor=this.getVisualEditor();raw_content=visualEditor.getContent({format:"raw",no_events:1});if(this.starting_content!==raw_content){text=rewriteStaticLinks(visualEditor.getContent({no_events:1}),this.base_asset_url,"/static/")}}if(text===void 0){text=this.advanced_editor.getValue()}return{data:text}};return HTMLEditingDescriptor}()}).call(this);(function(){var extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},hasProp={}.hasOwnProperty;this.SequenceDescriptor=function(superClass){extend(SequenceDescriptor,superClass);function SequenceDescriptor(){return SequenceDescriptor.__super__.constructor.apply(this,arguments)}return SequenceDescriptor}(XModule.Descriptor)}).call(this);(function(){var bind=function(fn,me){return function(){return fn.apply(me,arguments)}};this.TabsEditingDescriptor=function(){TabsEditingDescriptor.isInactiveClass="is-inactive";function TabsEditingDescriptor(element){this.onSwitchEditor=bind(this.onSwitchEditor,this);var currentTab;this.element=element;this.$tabs=$(".tab",this.element);this.$content=$(".component-tab",this.element);this.element.find(".editor-tabs .tab").each(function(_this){return function(index,value){return $(value).on("click",_this.onSwitchEditor)}}(this));currentTab=this.$tabs.filter(".current");if(currentTab.length!==1){currentTab=this.$tabs.first()}this.html_id=this.$tabs.closest(".wrapper-comp-editor").data("html_id");currentTab.trigger("click",[true,this.html_id])}TabsEditingDescriptor.prototype.onSwitchEditor=function(e,firstTime,html_id){var $currentTarget,content_id,isInactiveClass,onSwitchFunction,previousTab;e.preventDefault();isInactiveClass=TabsEditingDescriptor.isInactiveClass;$currentTarget=$(e.currentTarget);if(!$currentTarget.hasClass("current")||firstTime===true){previousTab=null;this.$tabs.each(function(index,value){if($(value).hasClass("current")){return previousTab=$(value).data("tab_name")}});TabsEditingDescriptor.Model.updateValue(this.html_id,previousTab);onSwitchFunction=TabsEditingDescriptor.Model.modules[this.html_id].tabSwitch[$currentTarget.data("tab_name")];if($.isFunction(onSwitchFunction)){onSwitchFunction()}this.$tabs.removeClass("current");$currentTarget.addClass("current");content_id=$currentTarget.attr("href");return this.$content.addClass(isInactiveClass).filter(content_id).removeClass(isInactiveClass)}};TabsEditingDescriptor.prototype.save=function(){var current_tab;this.element.off("click",".editor-tabs .tab",this.onSwitchEditor);current_tab=this.$tabs.filter(".current").data("tab_name");return{data:TabsEditingDescriptor.Model.getValue(this.html_id,current_tab)}};TabsEditingDescriptor.prototype.setMetadataEditor=function(metadataEditor){return TabsEditingDescriptor.setMetadataEditor.apply(TabsEditingDescriptor,arguments)};TabsEditingDescriptor.prototype.getStorage=function(){return TabsEditingDescriptor.getStorage()};TabsEditingDescriptor.prototype.addToStorage=function(id,data){return TabsEditingDescriptor.addToStorage.apply(TabsEditingDescriptor,arguments)};TabsEditingDescriptor.Model={addModelUpdate:function(id,tabName,modelUpdateFunction){this.initialize(id);return this.modules[id].modelUpdate[tabName]=modelUpdateFunction},addOnSwitch:function(id,tabName,onSwitchFunction){this.initialize(id);return this.modules[id].tabSwitch[tabName]=onSwitchFunction},updateValue:function(id,tabName){var modelUpdateFunction;this.initialize(id);modelUpdateFunction=this.modules[id]["modelUpdate"][tabName];if($.isFunction(modelUpdateFunction)){return this.modules[id]["value"]=modelUpdateFunction()}},getValue:function(id,tabName){if(!this.modules[id]){return null}if($.isFunction(this.modules[id]["modelUpdate"][tabName])){return this.modules[id]["modelUpdate"][tabName]()}else{if(typeof this.modules[id]["value"]==="undefined"){return null}else{return this.modules[id]["value"]}}},modules:{},Storage:{},initialize:function(id){this.modules[id]=this.modules[id]||{};this.modules[id].tabSwitch=this.modules[id]["tabSwitch"]||{};return this.modules[id].modelUpdate=this.modules[id]["modelUpdate"]||{}}};TabsEditingDescriptor.setMetadataEditor=function(metadataEditor){return TabsEditingDescriptor.Model.Storage["MetadataEditor"]=metadataEditor};TabsEditingDescriptor.addToStorage=function(id,data){return TabsEditingDescriptor.Model.Storage[id]=data};TabsEditingDescriptor.getStorage=function(){return TabsEditingDescriptor.Model.Storage};return TabsEditingDescriptor}()}).call(this);(function(){var extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},hasProp={}.hasOwnProperty;this.XMLEditingDescriptor=function(superClass){extend(XMLEditingDescriptor,superClass);function XMLEditingDescriptor(element){this.element=element;this.edit_box=CodeMirror.fromTextArea($(".edit-box",this.element)[0],{mode:"xml",lineNumbers:true,lineWrapping:true})}XMLEditingDescriptor.prototype.save=function(){return{data:this.edit_box.getValue()}};return XMLEditingDescriptor}(XModule.Descriptor)}).call(this);
