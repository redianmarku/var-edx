(function(){"use strict";function e(e,s){function i(){this.constructor=e}for(var n in s)t.call(s,n)&&(e[n]=s[n]);return i.prototype=s.prototype,e.prototype=new i,e.__super__=s.prototype,e}var t={}.hasOwnProperty,s=[].indexOf||function(e){for(var t=0,s=this.length;s>t;t++)if(t in this&&this[t]===e)return t;return-1};"undefined"!=typeof Backbone&&null!==Backbone&&(this.Content=function(t){function i(){return i.__super__.constructor.apply(this,arguments)}return e(i,t),i.contents={},i.contentInfos={},i.prototype.template=function(){return DiscussionUtil.getTemplate("_content")},i.prototype.actions={editable:".admin-edit",can_reply:".discussion-reply",can_delete:".admin-delete",can_openclose:".admin-openclose",can_report:".admin-report",can_vote:".admin-vote"},i.prototype.urlMappers={},i.prototype.urlFor=function(e){return this.urlMappers[e].apply(this)},i.prototype.can=function(e){return(this.get("ability")||{})[e]},i.prototype.canBeEndorsed=function(){return!1},i.prototype.updateInfo=function(e){return e?(this.set("ability",e.ability),this.set("voted",e.voted),this.set("subscribed",e.subscribed)):void 0},i.prototype.addComment=function(e,t){var s,i,n;return t=t||{},t.silent||(n=this.get("thread"),s=parseInt(n.get("comments_count")),n.set("comments_count",s+1)),this.get("children").push(e),i=new Comment($.extend({},e,{thread:this.get("thread")})),this.get("comments").add(i),this.trigger("comment:add"),i},i.prototype.removeComment=function(e){var t,s;return s=this.get("thread"),t=parseInt(s.get("comments_count")),s.set("comments_count",t-1-e.getCommentsCount()),this.trigger("comment:remove")},i.prototype.resetComments=function(e){var t,s,i,n,o;for(this.set("children",[]),this.set("comments",new Comments),n=e||[],o=[],s=0,i=n.length;i>s;s++)t=n[s],o.push(this.addComment(t,{silent:!0}));return o},i.prototype.initialize=function(){var e;return i.addContent(this.id,this),e=this.get("user_id"),e?(this.set("staff_authored",DiscussionUtil.isStaff(e)),this.set("community_ta_authored",DiscussionUtil.isTA(e)||DiscussionUtil.isGroupTA(e))):(this.set("staff_authored",!1),this.set("community_ta_authored",!1)),i.getInfo(this.id)&&this.updateInfo(i.getInfo(this.id)),this.set("user_url",DiscussionUtil.urlFor("user_profile",e)),this.resetComments(this.get("children"))},i.prototype.remove=function(){return"comment"===this.get("type")?(this.get("thread").removeComment(this),this.get("thread").trigger("comment:remove",this)):this.trigger("thread:remove",this)},i.addContent=function(e,t){this.contents[e]=t},i.getContent=function(e){return this.contents[e]},i.getInfo=function(e){return this.contentInfos[e]},i.loadContentInfos=function(e){var t,s;for(t in e)e.hasOwnProperty(t)&&(s=e[t],this.getContent(t)&&this.getContent(t).updateInfo(s));return $.extend(this.contentInfos,e)},i.prototype.pinThread=function(){var e;return e=this.get("pinned"),this.set("pinned",e),this.trigger("change",this)},i.prototype.unPinThread=function(){var e;return e=this.get("pinned"),this.set("pinned",e),this.trigger("change",this)},i.prototype.flagAbuse=function(){var e;return e=this.get("abuse_flaggers"),e.push(window.user.get("id")),this.set("abuse_flaggers",e),this.trigger("change",this)},i.prototype.unflagAbuse=function(){return this.get("abuse_flaggers").pop(window.user.get("id")),this.trigger("change",this)},i.prototype.isFlagged=function(){var e,t;return t=DiscussionUtil.getUser(),e=this.get("abuse_flaggers"),t&&(s.call(e,t.id)>=0||DiscussionUtil.isPrivilegedUser(t.id)&&e.length>0)},i.prototype.incrementVote=function(e){var t;return t=_.clone(this.get("votes")),t.up_count=t.up_count+e,this.set("votes",t)},i.prototype.vote=function(){return this.incrementVote(1)},i.prototype.unvote=function(){return this.incrementVote(-1)},i}(Backbone.Model),this.Thread=function(t){function s(){return s.__super__.constructor.apply(this,arguments)}return e(s,t),s.prototype.urlMappers={retrieve:function(){return DiscussionUtil.urlFor("retrieve_single_thread",this.get("commentable_id"),this.id)},reply:function(){return DiscussionUtil.urlFor("create_comment",this.id)},unvote:function(){return DiscussionUtil.urlFor("undo_vote_for_"+this.get("type"),this.id)},upvote:function(){return DiscussionUtil.urlFor("upvote_"+this.get("type"),this.id)},downvote:function(){return DiscussionUtil.urlFor("downvote_"+this.get("type"),this.id)},close:function(){return DiscussionUtil.urlFor("openclose_thread",this.id)},update:function(){return DiscussionUtil.urlFor("update_thread",this.id)},_delete:function(){return DiscussionUtil.urlFor("delete_thread",this.id)},follow:function(){return DiscussionUtil.urlFor("follow_thread",this.id)},unfollow:function(){return DiscussionUtil.urlFor("unfollow_thread",this.id)},flagAbuse:function(){return DiscussionUtil.urlFor("flagAbuse_"+this.get("type"),this.id)},unFlagAbuse:function(){return DiscussionUtil.urlFor("unFlagAbuse_"+this.get("type"),this.id)},pinThread:function(){return DiscussionUtil.urlFor("pin_thread",this.id)},unPinThread:function(){return DiscussionUtil.urlFor("un_pin_thread",this.id)}},s.prototype.initialize=function(){return this.set("thread",this),s.__super__.initialize.call(this)},s.prototype.comment=function(){return this.set("comments_count",parseInt(this.get("comments_count"))+1)},s.prototype.follow=function(){return this.set("subscribed",!0)},s.prototype.unfollow=function(){return this.set("subscribed",!1)},s.prototype.display_body=function(){return this.has("highlighted_body")?String(this.get("highlighted_body")).replace(/<highlight>/g,"<mark>").replace(/<\/highlight>/g,"</mark>"):this.get("body")},s.prototype.display_title=function(){return this.has("highlighted_title")?String(this.get("highlighted_title")).replace(/<highlight>/g,"<mark>").replace(/<\/highlight>/g,"</mark>"):this.get("title")},s.prototype.toJSON=function(){var e;return e=_.clone(this.attributes),_.extend(e,{title:this.display_title(),body:this.display_body()})},s.prototype.created_at_date=function(){return new Date(this.get("created_at"))},s.prototype.created_at_time=function(){return new Date(this.get("created_at")).getTime()},s.prototype.hasResponses=function(){return this.get("comments_count")>0},s}(this.Content),this.Comment=function(t){function s(){var e=this;return this.canBeEndorsed=function(){return s.prototype.canBeEndorsed.apply(e,arguments)},s.__super__.constructor.apply(this,arguments)}return e(s,t),s.prototype.urlMappers={reply:function(){return DiscussionUtil.urlFor("create_sub_comment",this.id)},unvote:function(){return DiscussionUtil.urlFor("undo_vote_for_"+this.get("type"),this.id)},upvote:function(){return DiscussionUtil.urlFor("upvote_"+this.get("type"),this.id)},downvote:function(){return DiscussionUtil.urlFor("downvote_"+this.get("type"),this.id)},endorse:function(){return DiscussionUtil.urlFor("endorse_comment",this.id)},update:function(){return DiscussionUtil.urlFor("update_comment",this.id)},_delete:function(){return DiscussionUtil.urlFor("delete_comment",this.id)},flagAbuse:function(){return DiscussionUtil.urlFor("flagAbuse_"+this.get("type"),this.id)},unFlagAbuse:function(){return DiscussionUtil.urlFor("unFlagAbuse_"+this.get("type"),this.id)}},s.prototype.getCommentsCount=function(){var e;return e=0,this.get("comments").each(function(t){return e+=t.getCommentsCount()+1}),e},s.prototype.canBeEndorsed=function(){var e;return e=window.user.get("id"),e&&(DiscussionUtil.isPrivilegedUser(e)||"question"===this.get("thread").get("thread_type")&&this.get("thread").get("user_id")===e)},s}(this.Content),this.Comments=function(t){function s(){return s.__super__.constructor.apply(this,arguments)}return e(s,t),s.prototype.model=Comment,s.prototype.initialize=function(){var e=this;return this.bind("add",function(t){t.collection=e})},s.prototype.find=function(e){return _.first(this.where({id:e}))},s}(Backbone.Collection))}).call(window),RequireJS.define("common/js/discussion/content",function(){}),function(){"use strict";var e={}.hasOwnProperty,t=function(t,s){function i(){this.constructor=t}for(var n in s)e.call(s,n)&&(t[n]=s[n]);return i.prototype=s.prototype,t.prototype=new i,t.__super__=s.prototype,t};"undefined"!=typeof Backbone&&null!==Backbone&&(this.Discussion=function(e){function s(){return s.__super__.constructor.apply(this,arguments)}return t(s,e),s.prototype.model=Thread,s.prototype.initialize=function(e,t){var s=this;return t||(t={}),this.pages=t.pages||1,this.current_page=1,this.sort_preference=t.sort,this.is_commentable_divided=t.is_commentable_divided,this.bind("add",function(e){e.discussion=s}),this.setSortComparator(this.sort_preference),this.on("thread:remove",function(e){s.remove(e)})},s.prototype.find=function(e){return _.first(this.where({id:e}))},s.prototype.hasMorePages=function(){return this.current_page<this.pages},s.prototype.setSortComparator=function(e){switch(e){case"activity":this.comparator=this.sortByDateRecentFirst;break;case"votes":this.comparator=this.sortByVotes;break;case"comments":this.comparator=this.sortByComments}},s.prototype.addThread=function(e){var t;return this.find(e.id)?void 0:(t=new Thread(e),this.add(t),t)},s.prototype.retrieveAnotherPage=function(e,t,s,i){var n,o,r=this;switch(t||(t={}),s||(s={}),n={page:this.current_page+1},_.contains(["unread","unanswered","flagged"],t.filter)&&(n[t.filter]=!0),e){case"search":o=DiscussionUtil.urlFor("search"),n.text=t.search_text;break;case"commentables":o=DiscussionUtil.urlFor("retrieve_discussion",t.commentable_ids),n.commentable_ids=t.commentable_ids;break;case"all":o=DiscussionUtil.urlFor("threads");break;case"followed":o=DiscussionUtil.urlFor("followed_threads",t.user_id);break;case"user":o=DiscussionUtil.urlFor("user_profile",t.user_id)}return t.group_id&&(n.group_id=t.group_id),n.sort_key=s.sort_key||"activity",n.sort_order=s.sort_order||"desc",DiscussionUtil.safeAjax({$elem:this.$el,url:o,data:n,dataType:"json",success:function(e){var t,s,i;return t=r.models,i=[function(){var t,s,i,o;for(i=e.discussion_data,o=[],t=0,s=i.length;s>t;t++)n=i[t],o.push(new Thread(n));return o}()][0],s=_.union(t,i),Content.loadContentInfos(e.annotated_content_info),r.pages=e.num_pages,r.current_page=e.page,r.is_commentable_divided=e.is_commentable_divided,r.reset(s)},error:i})},s.prototype.sortByDate=function(e){return this.pinnedThreadsSortComparatorWithDate(e,!0)},s.prototype.sortByDateRecentFirst=function(e){return this.pinnedThreadsSortComparatorWithDate(e,!1)},s.prototype.sortByVotes=function(e,t){var s,i;return s=parseInt(e.get("votes").up_count),i=parseInt(t.get("votes").up_count),this.pinnedThreadsSortComparatorWithCount(e,t,s,i)},s.prototype.sortByComments=function(e,t){var s,i;return s=parseInt(e.get("comments_count")),i=parseInt(t.get("comments_count")),this.pinnedThreadsSortComparatorWithCount(e,t,s,i)},s.prototype.pinnedThreadsSortComparatorWithCount=function(e,t,s,i){return e.get("pinned")&&!t.get("pinned")?-1:t.get("pinned")&&!e.get("pinned")?1:s>i?-1:i>s?1:e.created_at_time()>t.created_at_time()?-1:1},s.prototype.pinnedThreadsSortComparatorWithDate=function(e,t){var s,i,n;return i=new Date(e.get("last_activity_at")).getTime(),e.get("pinned")?(n=new Date,s=new Date(n.getTime()+864e5+i)):s=i,t?s:-s},s}(Backbone.Collection))}.call(window),RequireJS.define("common/js/discussion/discussion",function(){}),function(){"use strict";this.DiscussionUtil=function(){function e(){}e.wmdEditors={},e.leftKey=37,e.rightKey=39,e.getTemplate=function(e){return $("script#"+e).html()},e.setUser=function(e){this.user=e},e.getUser=function(){return this.user},e.loadRoles=function(e){this.roleIds=e},e.isStaff=function(e){var t;return _.isUndefined(e)&&(e=this.user?this.user.id:void 0),_.isUndefined(this.roleIds)&&(this.roleIds={}),t=_.union(this.roleIds.Moderator,this.roleIds.Administrator),_.include(t,parseInt(e))},e.isTA=function(e){var t;return _.isUndefined(e)&&(e=this.user?this.user.id:void 0),t=_.union(this.roleIds["Community TA"]),_.include(t,parseInt(e))},e.isGroupTA=function(e){var t,s=e;return _.isUndefined(e)&&(s=this.user?this.user.id:void 0),t=_.union(this.roleIds["Group Moderator"]),_.include(t,parseInt(s,10))},e.isPrivilegedUser=function(e){return this.isStaff(e)||this.isTA(e)},e.bulkUpdateContentInfo=function(e){var t,s,i;i=[];for(t in e)e.hasOwnProperty(t)&&(s=e[t],i.push(Content.getContent(t).updateInfo(s)));return i},e.generateDiscussionLink=function(e,t,s){return $("<a>").addClass("discussion-link").attr("href","#").addClass(e).text(t).click(function(){return s(this)})},e.urlFor=function(e,t,s,i){return{follow_discussion:"/courses/"+$$course_id+"/discussion/"+t+"/follow",unfollow_discussion:"/courses/"+$$course_id+"/discussion/"+t+"/unfollow",create_thread:"/courses/"+$$course_id+"/discussion/"+t+"/threads/create",update_thread:"/courses/"+$$course_id+"/discussion/threads/"+t+"/update",create_comment:"/courses/"+$$course_id+"/discussion/threads/"+t+"/reply",delete_thread:"/courses/"+$$course_id+"/discussion/threads/"+t+"/delete",flagAbuse_thread:"/courses/"+$$course_id+"/discussion/threads/"+t+"/flagAbuse",unFlagAbuse_thread:"/courses/"+$$course_id+"/discussion/threads/"+t+"/unFlagAbuse",flagAbuse_comment:"/courses/"+$$course_id+"/discussion/comments/"+t+"/flagAbuse",unFlagAbuse_comment:"/courses/"+$$course_id+"/discussion/comments/"+t+"/unFlagAbuse",upvote_thread:"/courses/"+$$course_id+"/discussion/threads/"+t+"/upvote",downvote_thread:"/courses/"+$$course_id+"/discussion/threads/"+t+"/downvote",pin_thread:"/courses/"+$$course_id+"/discussion/threads/"+t+"/pin",un_pin_thread:"/courses/"+$$course_id+"/discussion/threads/"+t+"/unpin",undo_vote_for_thread:"/courses/"+$$course_id+"/discussion/threads/"+t+"/unvote",follow_thread:"/courses/"+$$course_id+"/discussion/threads/"+t+"/follow",unfollow_thread:"/courses/"+$$course_id+"/discussion/threads/"+t+"/unfollow",update_comment:"/courses/"+$$course_id+"/discussion/comments/"+t+"/update",endorse_comment:"/courses/"+$$course_id+"/discussion/comments/"+t+"/endorse",create_sub_comment:"/courses/"+$$course_id+"/discussion/comments/"+t+"/reply",delete_comment:"/courses/"+$$course_id+"/discussion/comments/"+t+"/delete",upvote_comment:"/courses/"+$$course_id+"/discussion/comments/"+t+"/upvote",downvote_comment:"/courses/"+$$course_id+"/discussion/comments/"+t+"/downvote",undo_vote_for_comment:"/courses/"+$$course_id+"/discussion/comments/"+t+"/unvote",upload:"/courses/"+$$course_id+"/discussion/upload",users:"/courses/"+$$course_id+"/discussion/users",search:"/courses/"+$$course_id+"/discussion/forum/search",retrieve_discussion:"/courses/"+$$course_id+"/discussion/forum/"+t+"/inline",retrieve_single_thread:"/courses/"+$$course_id+"/discussion/forum/"+t+"/threads/"+s,openclose_thread:"/courses/"+$$course_id+"/discussion/threads/"+t+"/close",user_profile:"/courses/"+$$course_id+"/discussion/forum/users/"+t,followed_threads:"/courses/"+$$course_id+"/discussion/forum/users/"+t+"/followed",threads:"/courses/"+$$course_id+"/discussion/forum",enable_notifications:"/notification_prefs/enable/",disable_notifications:"/notification_prefs/disable/",notifications_status:"/notification_prefs/status/"}[e]},e.ignoreEnterKey=function(e){return 13===e.which?e.preventDefault():void 0},e.activateOnSpace=function(e,t){return 32===e.which?(e.preventDefault(),t(e)):void 0},e.makeFocusTrap=function(e){return e.keydown(function(e){return 9===e.which?e.preventDefault():void 0})},e.showLoadingIndicator=function(e,t){var s=edx.HtmlUtils.joinHtml(edx.HtmlUtils.HTML("<div class='loading-animation' tabindex='0'>"),edx.HtmlUtils.HTML("<span class='icon fa fa-spinner' aria-hidden='true'></span><span class='sr'>"),gettext("Loading content"),edx.HtmlUtils.HTML("</span></div>")),i=$(s.toString());e.after(i),this.$_loading=i,t&&(this.makeFocusTrap(this.$_loading),this.$_loading.focus())},e.hideLoadingIndicator=function(){return this.$_loading.remove()},e.discussionAlert=function(e,t){var s,i,n=$("#alert-popup").html()||"";0===$("#discussion-alert").length&&(s=$(edx.HtmlUtils.template(n)({}).toString()),this.makeFocusTrap(s.find("button")),i=$("<a href='#discussion-alert' id='discussion-alert-trigger'/>").css("display","none"),i.leanModal({closeButton:"#discussion-alert .dismiss",overlay:1,top:200}),$("body").append(s).append(i)),$("#discussion-alert header h2").text(e),$("#discussion-alert p").text(t),$("#discussion-alert-trigger").click(),$("#discussion-alert button").focus()},e.safeAjax=function(e){var t,s,i,n=this;return t=e.$elem,t&&t.prop("disabled")?(s=$.Deferred(),s.reject(),s.promise()):(e.url=URI(e.url).addSearch({ajax:1}),e.error||(e.error=function(){n.discussionAlert(gettext("Error"),gettext("Your request could not be processed. Refresh the page and try again."))}),t&&t.prop("disabled",!0),e.$loading&&(e.loadingCallback?e.loadingCallback.apply(e.$loading):n.showLoadingIndicator(e.$loading,e.takeFocus)),i=$.ajax(e).always(function(){return t&&t.prop("disabled",!1),e.$loading?e.loadedCallback?e.loadedCallback.apply(e.$loading):n.hideLoadingIndicator():void 0}))},e.updateWithUndo=function(e,t,s,i,n){var o,r=this;return i&&(s.error=function(){return r.discussionAlert(gettext("Error"),i)}),o=_.pick(e.attributes,_.keys(t)),e.set(t),"function"==typeof n&&n(),this.safeAjax(s).fail(function(){return e.set(o)})},e.bindLocalEvents=function(e,t){var s,i,n,o,r,a;a=[];for(i in t)t.hasOwnProperty(i)&&(n=t[i],r=i.split(" "),s=r[0],o=r[1],a.push(e(o).unbind(s)[s](n)));return a},e.formErrorHandler=function(e){return function(t){var s,i,n,o;if(s=function(e,t){return edx.HtmlUtils.joinHtml(edx.HtmlUtils.HTML("<li>"),edx.HtmlUtils.template($("#new-post-alert-template").html())({message:e,alertId:t}),edx.HtmlUtils.HTML("</li>"))},e.empty().show(),400===t.status){if(i=JSON.parse(t.responseText),i.errors)for(n=0;n<i.errors.length;n++)o=s(i.errors[n],n),edx.HtmlUtils.append(e,o)}else o=s("Your request could not be processed. Refresh the page and try again.",0),edx.HtmlUtils.append(e,o);$('div[role="alert"]',e).first().focus()}},e.clearFormErrors=function(e){return e.empty()},e.postMathJaxProcessor=function(e){var t,s;return s=/^\$([^\$]*)\$/g,t=/^\$\$([^\$]*)\$\$/g,this.processEachMathAndCode(e,function(e,i){return"display"===i?e.replace(t,function(e,t){return"\\["+t+"\\]"}):"inline"===i?e.replace(s,function(e,t){return"\\("+t+"\\)"}):e})},e.makeWmdEditor=function(e,t,s){var i,n,o,r,a,d,u;return o=t("."+s),d=o.data("placeholder"),r=o.data("id"),i="-"+s+"-"+r,a=this.urlFor("upload"),u=function(e){return function(t){return e.postMathJaxProcessor(edx.HtmlUtils.HTML(t)).toString()}},n=Markdown.makeWmdEditor(o,i,a,u(this)),this.wmdEditors[""+s+"-"+r]=n,d&&o.find("#wmd-input"+i).attr("placeholder",d),n},e.getWmdEditor=function(e,t,s){var i,n;return i=t("."+s),n=i.attr("data-id"),this.wmdEditors[""+s+"-"+n]},e.getWmdInput=function(e,t,s){var i,n;return i=t("."+s),n=i.attr("data-id"),t("#wmd-input-"+s+"-"+n)},e.getWmdContent=function(e,t,s){return this.getWmdInput(e,t,s).val()},e.setWmdContent=function(e,t,s,i){return this.getWmdInput(e,t,s).val(i),this.getWmdEditor(e,t,s).refreshPreview()};var t=/^([^\$]*?)\$\$([^\$]*?)\$\$(.*)$/m,s=/^([^\$]*?)\$([^\$]+?)\$(.*)$/m,i="@@ESCAPED_D@@",n="@@ESCAPED_B@@";return e.processEachMathAndCode=function(e,o){var r,a,d,u;for(a={},d="",r=edx.HtmlUtils.setHtml($("<div>"),edx.HtmlUtils.ensureHtml(e)),r.find("code").each(function(e,t){return a[e]=$(t).html(),$(t).text(e)}),u=r.html(),u=u.replace(/\\\$/g,i);;)if(s.test(u))u=u.replace(s,function(e,t,s,i){return d+=t+o("$"+s+"$","inline"),i});else{if(!t.test(u)){d+=u;break}u=u.replace(t,function(e,t,s,i){return d+=t+o("$$"+s+"$$","display"),i})}return u=d,u=u.replace(new RegExp(i,"g"),"\\$"),u=u.replace(/\\\\\\\\/g,n),u=u.replace(/\\begin\{([a-z]*\*?)\}([\s\S]*?)\\end\{\1\}/gim,function(e,t,s){return o("\\begin{"+t+"}"+s+("\\end{"+t+"}"))}),u=u.replace(new RegExp(n,"g"),"\\\\\\\\"),r=edx.HtmlUtils.setHtml($("<div>"),edx.HtmlUtils.HTML(u)),r.find("code").each(function(e,t){edx.HtmlUtils.setHtml($(t),edx.HtmlUtils.HTML(o(a[e],"code")))}),edx.HtmlUtils.HTML(r.html())},e.unescapeHighlightTag=function(e){return edx.HtmlUtils.HTML(e.toString().replace(/\&lt\;highlight\&gt\;/g,"<span class='search-highlight'>").replace(/\&lt\;\/highlight\&gt\;/g,"</span>"))},e.stripHighlight=function(e){return e.replace(/\&(amp\;)?lt\;highlight\&(amp\;)?gt\;/g,"").replace(/\&(amp\;)?lt\;\/highlight\&(amp\;)?gt\;/g,"")},e.stripLatexHighlight=function(e){return this.processEachMathAndCode(e,this.stripHighlight)},e.markdownWithHighlight=function(e){var t;e=e.replace(/^\&gt\;/gm,">"),t=Markdown.getMathCompatibleConverter();var s=edx.HtmlUtils.HTML(t.makeHtml(e));return this.unescapeHighlightTag(this.stripLatexHighlight(s))},e.abbreviateString=function(e,t){if(e.length<t)return e;for(;t<e.length&&" "!==e[t];)t++;return e.substr(0,t)+gettext("…")},e.convertMath=function(e){edx.HtmlUtils.setHtml(e,this.postMathJaxProcessor(this.markdownWithHighlight(e.text())))},e.typesetMathJax=function(e){"undefined"!=typeof MathJax&&null!==MathJax&&MathJax.Hub.Queue(["Typeset",MathJax.Hub,e[0]])},e.abbreviateHTML=function(e,t){var s,i,n;n=edx.HtmlUtils.HTML(jQuery.truncate(e.toString(),{length:t,noBreaks:!0,ellipsis:gettext("…")})),s=$(edx.HtmlUtils.joinHtml(edx.HtmlUtils.HTML("<div>"),n,edx.HtmlUtils.HTML("</div>")).toString()),i=s.find("img:not(:first)"),i.length>0&&edx.HtmlUtils.append(s,edx.HtmlUtils.interpolateHtml(edx.HtmlUtils.HTML("<p><em>{text}</em></p>"),{text:gettext("Some images in this post have been omitted")}));var o=edx.HtmlUtils.interpolateHtml(edx.HtmlUtils.HTML("<em>{text}</em>"),{text:gettext("image omitted")});return i.after(edx.HtmlUtils.ensureHtml(o).toString()).remove(),s.html()},e.getPaginationParams=function(e,t,s){var i,n,o,r;return i=2,o=Math.max(e-i,1),n=Math.min(e+i,t),r=function(e){return{number:e,url:s(e)}},{page:e,lowPages:_.range(o,e).map(r),highPages:_.range(e+1,n+1).map(r),previous:e>1?r(e-1):null,next:t>e?r(e+1):null,leftdots:o>2,rightdots:t-1>n,first:o>1?r(1):null,last:t>n?r(t):null}},e.handleKeypressInToolbar=function(e){var t,s,i,n,o,r,a,d,u;t=$(e.target),o=e.which||e.keyCode,i=t.parent(),n=i.children(".wmd-button"),d=o===this.leftKey||o===this.rightKey,u=n.length>0,d&&u&&(a=n.index(t),r=o===this.leftKey?a-1:a+1,r=Math.max(Math.min(r,n.length-1),0),s=$(n[r]),this.moveSelectionToNextItem(t,s))},e.moveSelectionToNextItem=function(e,t){e.attr("aria-selected","false"),e.attr("tabindex","-1"),t.attr("aria-selected","true"),t.attr("tabindex","0"),t.focus()},e}.call(this)}.call(window),RequireJS.define("common/js/discussion/utils",function(){}),function(){"use strict";var e={}.hasOwnProperty,t=function(t,s){function i(){this.constructor=t}for(var n in s)e.call(s,n)&&(t[n]=s[n]);return i.prototype=s.prototype,t.prototype=new i,t.__super__=s.prototype,t};"undefined"!=typeof Backbone&&null!==Backbone&&(this.DiscussionCourseSettings=function(e){function s(){return s.__super__.constructor.apply(this,arguments)}return t(s,e),s}(Backbone.Model))}.call(this),RequireJS.define("common/js/discussion/models/discussion_course_settings",function(){}),function(){"use strict";var e={}.hasOwnProperty,t=function(t,s){function i(){this.constructor=t}for(var n in s)e.call(s,n)&&(t[n]=s[n]);return i.prototype=s.prototype,t.prototype=new i,t.__super__=s.prototype,t};"undefined"!=typeof Backbone&&null!==Backbone&&(this.DiscussionUser=function(e){function s(){return s.__super__.constructor.apply(this,arguments)}return t(s,e),s.prototype.following=function(e){return _.include(this.get("subscribed_thread_ids"),e.id)},s.prototype.voted=function(e){return _.include(this.get("upvoted_ids"),e.id)},s.prototype.vote=function(e){return this.get("upvoted_ids").push(e.id),e.vote()},s.prototype.unvote=function(e){return this.set("upvoted_ids",_.without(this.get("upvoted_ids"),e.id)),e.unvote()},s}(Backbone.Model))}.call(this),RequireJS.define("common/js/discussion/models/discussion_user",function(){}),function(){"use strict";var e={}.hasOwnProperty,t=function(t,s){function i(){this.constructor=t}for(var n in s)e.call(s,n)&&(t[n]=s[n]);return i.prototype=s.prototype,t.prototype=new i,t.__super__=s.prototype,t};"undefined"!=typeof Backbone&&null!==Backbone&&(this.NewPostView=function(e){function s(){var e=this;return this.updateStyles=function(){return s.prototype.updateStyles.apply(e,arguments)},this.resetForm=function(){return s.prototype.resetForm.apply(e,arguments)},s.__super__.constructor.apply(this,arguments)}return t(s,e),s.prototype.initialize=function(e){var t;if(this.mode=e.mode||"inline",this.startHeader=e.startHeader,"tab"!==(t=this.mode)&&"inline"!==t)throw new Error("invalid mode: "+this.mode);this.course_settings=e.course_settings,this.is_commentable_divided=e.is_commentable_divided,this.user_group_id=e.user_group_id,this.topicId=e.topicId,this.discussionBoardView=e.discussionBoardView},s.prototype.render=function(){var e,t;return e=_.clone(this.course_settings.attributes),_.extend(e,{group_options:this.getGroupOptions(),is_commentable_divided:this.is_commentable_divided,is_discussion_division_enabled:this.course_settings.get("is_discussion_division_enabled"),mode:this.mode,startHeader:this.startHeader,form_id:this.mode+(this.topicId?"-"+this.topicId:"")}),this.$el.html(_.template($("#new-post-template").html())(e)),t=_.template($("#thread-type-template").html()),$(".js-group-select").prop("disabled")&&$(".group-selector-wrapper").addClass("disabled"),this.addField(t({form_id:_.uniqueId("form-")})),this.isTabMode()?(this.topicView=new DiscussionTopicMenuView({topicId:this.topicId,course_settings:this.course_settings,group_name:this.getGroupName()}),this.topicView.on("thread:topic_change",this.toggleGroupDropdown),this.course_settings.get("is_discussion_division_enabled")&&this.topicView.on("thread:topic_change",this.updateVisibilityMessage),this.addField(this.topicView.render())):(this.group_name=this.getGroupName(),this.updateVisibilityMessage(null,this.is_commentable_divided)),DiscussionUtil.makeWmdEditor(this.$el,$.proxy(this.$,this),"js-post-body")},s.prototype.addField=function(e){return this.$(".forum-new-post-form-wrapper").append(e)},s.prototype.isTabMode=function(){return"tab"===this.mode},s.prototype.getGroupOptions=function(){var e;return this.course_settings.get("is_discussion_division_enabled")&&DiscussionUtil.isPrivilegedUser()?(e=$("#discussion-container").data("user-group-id"),_.map(this.course_settings.get("groups"),function(t){return{value:t.id,text:t.name,selected:t.id===e}})):null},s.prototype.getGroupName=function(){var e,t,s=null;return this.course_settings.get("is_discussion_division_enabled")&&(e=$("#discussion-container").data("user-group-id"),e||(e=this.user_group_id),t=this.course_settings.get("groups").find(function(t){return t.id===String(e)}),t&&(s=t.name)),s},s.prototype.events={"keypress .forum-new-post-form input:not(.wmd-input)":function(e){return DiscussionUtil.ignoreEnterKey(e)},"submit .forum-new-post-form":"createPost","change .post-option-input":"postOptionChange","change .js-group-select":"groupOptionChange","click .cancel":"cancel","click  .add-post-cancel":"cancel","reset .forum-new-post-form":"updateStyles","keydown .wmd-button":function(e){return DiscussionUtil.handleKeypressInToolbar(e)}},s.prototype.toggleGroupDropdown=function(e){return e.data("divided")?($(".js-group-select").prop("disabled",!1),$(".js-group-select").val("").prop("selected",!0),$(".group-selector-wrapper").removeClass("disabled")):($(".js-group-select").val("").prop("disabled",!0),$(".group-selector-wrapper").addClass("disabled"))},s.prototype.updateVisibilityMessage=function(e,t){var s=$("#wrapper-visibility-message"),i=edx.HtmlUtils.template($("#new-post-visibility-template").html()),n=null;(e&&e.data("divided")||t)&&(n=this.group_name),edx.HtmlUtils.setHtml(s,i({group_name:n}))},s.prototype.postOptionChange=function(e){var t,s;return s=$(e.target),t=s.closest(".post-option"),s.is(":checked")?t.addClass("is-enabled"):t.removeClass("is-enabled")},s.prototype.createPost=function(e){var t,s,i,n,o,r,a,d,u,c=this;return e.preventDefault(),r=this.$(".input-radio:checked").val(),a=this.$(".js-post-title").val(),i=this.$(".js-post-body").find(".wmd-input").val(),o=this.$(".js-group-select option:selected").attr("value"),t=this.$("input[name=anonymous]").is(":checked"),s=this.$("input[name=anonymous_to_peers]").is(":checked"),n=this.$("input[name=follow]").is(":checked"),d=this.isTabMode()?this.topicView.getCurrentTopicId():this.topicId,u=DiscussionUtil.urlFor("create_thread",d),DiscussionUtil.safeAjax({$elem:$(e.target),$loading:e?$(e.target):void 0,url:u,type:"POST",dataType:"json",data:{thread_type:r,title:a,body:i,anonymous:t,anonymous_to_peers:s,auto_subscribe:n,group_id:o},error:DiscussionUtil.formErrorHandler(this.$(".post-errors")),success:function(e){var t,s;return t=new Thread(e.content),c.discussionBoardView&&(s=c.discussionBoardView.breadcrumbs.model,s.get("contents").length&&s.set("contents",c.topicView.topicText.split("/")),c.discussionBoardView.discussionThreadListView.discussionIds=c.topicView.currentTopicId),c.$el.addClass("is-hidden"),c.resetForm(),c.trigger("newPost:createPost"),c.collection.add(t)}})},s.prototype.formModified=function(){var e=""!==this.$(".js-post-body").find(".wmd-input").val(),t=""!==this.$(".js-post-title").val();return e||t},s.prototype.cancel=function(e){e.preventDefault(),(!this.formModified()||confirm(gettext("Your post will be discarded.")))&&(this.trigger("newPost:cancel"),this.resetForm())},s.prototype.resetForm=function(){var e;this.$(".forum-new-post-form")[0].reset(),DiscussionUtil.clearFormErrors(this.$(".post-errors")),this.$(".wmd-preview").html(""),this.isTabMode()&&(e=this.$(".post-topic option:contains(General)"),this.topicView.setTopic(e||this.$("button.topic-title").first()))},s.prototype.updateStyles=function(){var e=this;return setTimeout(function(){return e.$(".post-option-input").trigger("change")},1)},s.prototype.groupOptionChange=function(e){var t=$(e.target),s=t.data();this.group_name=this.$(".js-group-select option:selected").text(),s.divided=!0,this.updateVisibilityMessage(t)},s}(Backbone.View))}.call(window),RequireJS.define("common/js/discussion/views/new_post_view",function(){}),function(){"use strict";var e={}.hasOwnProperty,t=function(t,s){function i(){this.constructor=t}for(var n in s)e.call(s,n)&&(t[n]=s[n]);return i.prototype=s.prototype,t.prototype=new i,t.__super__=s.prototype,t};"undefined"!=typeof Backbone&&null!==Backbone&&(this.DiscussionThreadView=function(e){function s(){var e=this;return this._delete=function(){return s.prototype._delete.apply(e,arguments)},this.closeEditView=function(){return s.prototype.closeEditView.apply(e,arguments)},this.edit=function(){return s.prototype.edit.apply(e,arguments)},this.endorseThread=function(){return s.prototype.endorseThread.apply(e,arguments)},this.addComment=function(){return s.prototype.addComment.apply(e,arguments)},this.renderAddResponseButton=function(){return s.prototype.renderAddResponseButton.apply(e,arguments)},this.renderResponseToList=function(){return s.prototype.renderResponseToList.apply(e,arguments)},this.renderResponseCountAndPagination=function(){return s.prototype.renderResponseCountAndPagination.apply(e,arguments)},s.__super__.constructor.apply(this,arguments)}var i,n;return t(s,e),i=25,n=100,s.prototype.events={"click .discussion-submit-post":"submitComment","click .add-response-btn":"scrollToAddResponse","keydown .wmd-button":function(e){return DiscussionUtil.handleKeypressInToolbar(e)}},s.prototype.$=function(e){return this.$el.find(e)},s.prototype.isQuestion=function(){return"question"===this.model.get("thread_type")},s.prototype.initialize=function(e){var t,i=this;if(s.__super__.initialize.call(this),this.mode=e.mode||"inline",this.context=e.context||"course",this.options=_.extend({},e),this.startHeader=e.startHeader,"tab"!==(t=this.mode)&&"inline"!==t)throw new Error("invalid mode: "+this.mode);this.readOnly=$(".discussion-module").data("read-only"),this.model.collection.on("reset",function(e){var t;t=i.model.get("id"),e.get(t)&&(i.model=e.get(t))}),this.is_commentable_divided=e.is_commentable_divided,
this.createShowView(),this.responses=new Comments,this.loadedResponses=!1,this.isQuestion()&&(this.markedAnswers=new Comments)},s.prototype.rerender=function(){return this.showView&&this.showView.undelegateEvents(),this.undelegateEvents(),this.$el.empty(),this.initialize({mode:this.mode,model:this.model,el:this.el,courseSettings:this.options.courseSettings,topicId:this.topicId}),this.render()},s.prototype.renderTemplate=function(){var e,t;return this.template=_.template($("#thread-template").html()),e=$("#discussion-container"),e.length||(e=$(".discussion-module")),t=_.extend(this.model.toJSON(),{readOnly:this.readOnly,startHeader:this.startHeader+1,can_create_comment:e.data("user-create-comment")}),this.template(t)},s.prototype.render=function(){var e=this,t=$(this.renderTemplate());this.$el.empty(),this.$el.append(t),this.delegateEvents(),this.renderShowView(),this.renderAttrs(),this.$("span.timeago").timeago(),this.makeWmdEditor("reply-body"),this.renderAddResponseButton(),this.responses.on("add",function(t){return e.renderResponseToList(t,".js-response-list",{})}),this.isQuestion()&&this.markedAnswers.on("add",function(t){return e.renderResponseToList(t,".js-marked-answer-list",{collapseComments:!0})}),this.loadInitialResponses()},s.prototype.attrRenderer=$.extend({},DiscussionContentView.prototype.attrRenderer,{closed:function(e){return this.$(".discussion-reply-new").toggle(!e),this.$(".comment-form").closest("li").toggle(!e),this.$(".action-vote").toggle(!e),this.$(".display-vote").toggle(e),this.renderAddResponseButton()}}),s.prototype.cleanup=function(){return this.responsesRequest&&this.responsesRequest.abort?this.responsesRequest.abort():void 0},s.prototype.loadResponses=function(e,t,s){var i=this;this.responsesRequest=DiscussionUtil.safeAjax({url:DiscussionUtil.urlFor("retrieve_single_thread",this.model.get("commentable_id"),this.model.id),data:{resp_skip:this.responses.size(),resp_limit:e||void 0},$elem:t,$loading:t,takeFocus:!1,complete:function(){i.responsesRequest=null},success:function(e){Content.loadContentInfos(e.annotated_content_info),i.isQuestion()&&i.markedAnswers.add(e.content.endorsed_responses),i.responses.add(i.isQuestion()?e.content.non_endorsed_responses:e.content.children),i.renderResponseCountAndPagination(i.isQuestion()?e.content.non_endorsed_resp_total:e.content.resp_total),i.trigger("thread:responses:rendered"),i.loadedResponses=!0},error:function(e,t){"abort"!==t&&(404===e.status?DiscussionUtil.discussionAlert(gettext("Error"),gettext("The post you selected has been deleted.")):s?DiscussionUtil.discussionAlert(gettext("Error"),gettext("Responses could not be loaded. Refresh the page and try again.")):DiscussionUtil.discussionAlert(gettext("Error"),gettext("Additional responses could not be loaded. Refresh the page and try again.")))}})},s.prototype.loadInitialResponses=function(){return this.loadResponses(i,this.$el.find(".js-response-list"),!0)},s.prototype.renderResponseCountAndPagination=function(e){var t,s,i,o,r,a,d,u=this;if(this.isQuestion()&&0!==this.markedAnswers.length?(i=ngettext("{numResponses} other response","{numResponses} other responses",e),0===e&&this.$el.find(".response-count").hide()):i=ngettext("{numResponses} response","{numResponses} responses",e),this.$el.find(".response-count").text(edx.StringUtils.interpolate(i,{numResponses:e},!0)),r=this.$el.find(".response-pagination"),r.empty(),e>0){if(a=e-this.responses.size(),d=0===a?gettext("Showing all responses"):edx.StringUtils.interpolate(ngettext("Showing first response","Showing first {numResponses} responses",this.responses.size()),{numResponses:this.responses.size()},!0),r.append($("<span>").addClass("response-display-count").text(d)),a>0)return n>a?(o=null,t=gettext("Load all responses")):(o=n,t=edx.StringUtils.interpolate(gettext("Load next {numResponses} responses"),{numResponses:o},!0)),s=$("<button>").addClass("btn-neutral").addClass("load-response-button").text(t),s.click(function(){return u.loadResponses(o,s)}),r.append(s)}else this.$el.find(".add-response").hide()},s.prototype.renderResponseToList=function(e,t,s){var i;return e.set("thread",this.model),i=new ThreadResponseView($.extend({model:e,startHeader:this.startHeader+1},s)),i.on("comment:add",this.addComment),i.on("comment:endorse",this.endorseThread),i.render(),this.$el.find(t).append(i.el),i.afterInsert(),s.focusAddedResponse&&this.focusToTheAddedResponse(i.el),DiscussionUtil.typesetMathJax(i.$el),i},s.prototype.renderAddResponseButton=function(){return this.model.hasResponses()&&this.model.can("can_reply")&&!this.model.get("closed")?this.$el.find(".add-response").show():this.$el.find(".add-response").hide()},s.prototype.scrollToAddResponse=function(e){var t;return e.preventDefault(),t=$(e.target).parents("article.discussion-article").find("form.discussion-reply-new"),$("html, body").scrollTop(t.offset().top),t.find(".wmd-panel textarea").focus()},s.prototype.addComment=function(){return this.model.comment()},s.prototype.endorseThread=function(){return this.model.set("endorsed",this.$el.find(".action-answer.is-checked").length>0)},s.prototype.submitComment=function(e){var t,s,i,n;return e.preventDefault(),i=this.model.urlFor("reply"),t=this.getWmdContent("reply-body"),t.trim().length?(this.setWmdContent("reply-body",""),s=new Comment({body:t,created_at:(new Date).toISOString(),username:window.user.get("username"),votes:{up_count:0},abuse_flaggers:[],endorsed:!1,user_id:window.user.get("id")}),s.set("thread",this.model.get("thread")),n=this.renderResponseToList(s,".js-response-list",{focusAddedResponse:!0}),this.model.addComment(),this.renderAddResponseButton(),DiscussionUtil.safeAjax({$elem:$(e.target),url:i,type:"POST",dataType:"json",data:{body:t},success:function(e){s.updateInfo(e.annotated_content_info),s.set(e.content),DiscussionUtil.typesetMathJax(n.$el.find(".response-body"))}})):void 0},s.prototype.focusToTheAddedResponse=function(e){return $(e).attr("tabindex","-1").focus()},s.prototype.edit=function(){return this.createEditView(),this.renderEditView()},s.prototype.createEditView=function(){return this.showView&&(this.showView.undelegateEvents(),this.showView.$el.empty(),this.showView=null),this.editView=new DiscussionThreadEditView({container:this.$(".thread-content-wrapper"),model:this.model,mode:this.mode,context:this.context,startHeader:this.startHeader,course_settings:this.options.courseSettings}),this.editView.bind("thread:updated thread:cancel_edit",this.closeEditView),this.editView.bind("comment:endorse",this.endorseThread)},s.prototype.renderSubView=function(e){return e.setElement(this.$(".thread-content-wrapper")),e.render(),e.delegateEvents()},s.prototype.renderEditView=function(){return this.editView.render()},s.prototype.createShowView=function(){return this.showView=new DiscussionThreadShowView({model:this.model,mode:this.mode,startHeader:this.startHeader,is_commentable_divided:this.is_commentable_divided}),this.showView.bind("thread:_delete",this._delete),this.showView.bind("thread:edit",this.edit)},s.prototype.renderShowView=function(){return this.renderSubView(this.showView)},s.prototype.closeEditView=function(){return this.createShowView(),this.renderShowView(),this.renderAttrs(),this.$el.find(".post-extended-content").show()},s.prototype._delete=function(e){var t,s;return s=this.model.urlFor("_delete"),this.model.can("can_delete")&&confirm(gettext("Are you sure you want to delete this post?"))?(this.model.remove(),this.showView.undelegateEvents(),this.undelegateEvents(),this.$el.empty(),t=$(e.target),DiscussionUtil.safeAjax({$elem:t,url:s,type:"POST"})):void 0},s}(DiscussionContentView))}.call(window),RequireJS.define("common/js/discussion/views/discussion_thread_view",function(){}),function(e){"use strict";RequireJS.define("discussion/js/discussion_router",["underscore","backbone","common/js/discussion/utils","common/js/discussion/views/discussion_thread_view"],function(e,t,s,i){var n=t.Router.extend({routes:{"":"allThreads",":forum_name/threads/:thread_id":"showThread"},initialize:function(s){t.Router.prototype.initialize.call(this),e.bindAll(this,"allThreads","showThread"),this.rootUrl=s.rootUrl,this.discussion=s.discussion,this.courseSettings=s.courseSettings,this.discussionBoardView=s.discussionBoardView,this.newPostView=s.newPostView,void 0!==s.startHeader?this.startHeader=s.startHeader:this.startHeader=2},start:function(){var i=this,n=$(".new-post-btn");this.listenTo(this.newPostView,"newPost:cancel",this.hideNewPost),n.bind("click",e.bind(this.showNewPost,this)),n.bind("keydown",function(e){s.activateOnSpace(e,i.showNewPost)}),this.discussionBoardView.discussionThreadListView.on("thread:selected",e.bind(this.navigateToThread,this)),this.discussionBoardView.discussionThreadListView.on("thread:removed",e.bind(this.navigateToAllThreads,this)),this.discussionBoardView.discussionThreadListView.on("threads:rendered",e.bind(this.setActiveThread,this)),this.discussionBoardView.discussionThreadListView.on("thread:created",e.bind(this.navigateToThread,this)),t.history.start({pushState:!0,root:this.rootUrl})},stop:function(){t.history.stop()},allThreads:function(){return this.discussionBoardView.goHome()},setActiveThread:function(){return this.thread?this.discussionBoardView.discussionThreadListView.setActiveThread(this.thread.get("id")):this.discussionBoardView.goHome},showThread:function(e,t){return this.thread=this.discussion.get(t),this.thread.set("unread_comments_count",0),this.thread.set("read",!0),this.setActiveThread(),this.showMain()},showMain:function(){return this.main&&(this.main.cleanup(),this.main.undelegateEvents()),$(".forum-content").is(":visible")||$(".forum-content").fadeIn(),$(".new-post-article").is(":visible")&&$(".new-post-article").fadeOut(),this.main=new i({el:$(".forum-content"),model:this.thread,mode:"tab",startHeader:this.startHeader,courseSettings:this.courseSettings,is_commentable_divided:this.discussion.is_commentable_divided}),this.main.render(),this.thread.on("thread:thread_type_updated",this.showMain)},navigateToThread:function(e){var t=this.discussion.get(e);return this.navigate(""+t.get("commentable_id")+"/threads/"+e,{trigger:!0})},navigateToAllThreads:function(){return this.navigate("",{trigger:!0})},showNewPost:function(){var e=this;return $(".forum-content").fadeOut({duration:200,complete:function(){return e.newPostView.$el.fadeIn(200).focus()}})},hideNewPost:function(){return this.newPostView.$el.fadeOut({duration:200,complete:function(){return $(".forum-content").fadeIn(200).find(".thread-wrapper").focus()}})}});return n})}.call(this,define||RequireJS.define),function(e){"use strict";RequireJS.define("edx-ui-toolkit/js/utils/constants",[],function(){return{keys:{tab:"Tab",enter:"Enter",esc:"Escape",space:"Space",left:"ArrowLeft",up:"ArrowUp",right:"ArrowRight",down:"ArrowDown"},keyCodes:{tab:9,enter:13,esc:27,space:32,left:37,up:38,right:39,down:40}}})}.call(this,"function"==typeof RequireJS.define&&RequireJS.define.amd?RequireJS.define:"undefined"!=typeof RequireJS?RequireJS.define:edx.GlobalLoader.defineAs("constants","edx-ui-toolkit/js/utils/constants")),function(){"use strict";var e={}.hasOwnProperty,t=function(t,s){function i(){this.constructor=t}for(var n in s)e.call(s,n)&&(t[n]=s[n]);return i.prototype=s.prototype,t.prototype=new i,t.__super__=s.prototype,t};"undefined"!=typeof Backbone&&null!==Backbone&&(this.DiscussionThreadListView=function(e){function s(){var e=this;return this.updateEmailNotifications=function(){return s.prototype.updateEmailNotifications.apply(e,arguments)},this.retrieveFollowed=function(){return s.prototype.retrieveFollowed.apply(e,arguments)},this.chooseGroup=function(){return s.prototype.chooseGroup.apply(e,arguments)},this.chooseFilter=function(){return s.prototype.chooseFilter.apply(e,arguments)},this.threadRemoved=function(){return s.prototype.threadRemoved.apply(e,arguments)},this.threadSelected=function(){return s.prototype.threadSelected.apply(e,arguments)},this.renderThread=function(){return s.prototype.renderThread.apply(e,arguments)},this.loadMorePages=function(){return s.prototype.loadMorePages.apply(e,arguments)},this.showMetadataAccordingToSort=function(){return s.prototype.showMetadataAccordingToSort.apply(e,arguments)},this.renderThreads=function(){return s.prototype.renderThreads.apply(e,arguments)},this.addAndSelectThread=function(){return s.prototype.addAndSelectThread.apply(e,arguments)},this.reloadDisplayedCollection=function(){return s.prototype.reloadDisplayedCollection.apply(e,arguments)},this.clearSearchAlerts=function(){return s.prototype.clearSearchAlerts.apply(e,arguments)},this.removeSearchAlert=function(){return s.prototype.removeSearchAlert.apply(e,arguments)},this.addSearchAlert=function(){return s.prototype.addSearchAlert.apply(e,arguments)},this.performSearch=function(){return s.prototype.performSearch.apply(e,arguments)},s.__super__.constructor.apply(this,arguments)}return t(s,e),s.prototype.events={"keypress .forum-nav-browse-filter-input":function(e){return DiscussionUtil.ignoreEnterKey(e)},"change .forum-nav-sort-control":"sortThreads","click .forum-nav-thread-link":"threadSelected","click .forum-nav-load-more-link":"loadMorePages","change .forum-nav-filter-main-control":"chooseFilter","change .forum-nav-filter-cohort-control":"chooseGroup"},s.prototype.initialize=function(e){var t=this;this.courseSettings=e.courseSettings,this.supportsActiveThread=e.supportsActiveThread,this.hideReadState=e.hideReadState||!1,this.displayedCollection=new Discussion(this.collection.models,{pages:this.collection.pages}),this.collection.on("change",this.reloadDisplayedCollection),this.discussionIds=this.$el.data("discussion-id")||"",this.collection.on("reset",function(e){return t.displayedCollection.current_page=e.current_page,t.displayedCollection.pages=e.pages,t.displayedCollection.reset(e.models)}),this.collection.on("add",this.addAndSelectThread),this.collection.on("thread:remove",this.threadRemoved),this.sidebar_padding=10,this.boardName=null,this.current_search="",this.mode=e.mode||"commentables",this.showThreadPreview=!0,this.searchAlertCollection=new Backbone.Collection([],{model:Backbone.Model}),this.searchAlertCollection.on("add",function(e){var s;return s=edx.HtmlUtils.template($("#search-alert-template").html())({messageHtml:e.attributes.message,cid:e.cid,css_class:e.attributes.css_class}),edx.HtmlUtils.append(t.$(".search-alerts"),s),t.$("#search-alert-"+e.cid+" .dismiss").bind("click",e,function(e){return t.removeSearchAlert(e.data.cid)})}),this.searchAlertCollection.on("remove",function(e){return t.$("#search-alert-"+e.cid).remove()}),this.searchAlertCollection.on("reset",function(){return t.$(".search-alerts").empty()}),this.template=edx.HtmlUtils.template($("#thread-list-template").html()),this.threadListItemTemplate=edx.HtmlUtils.template($("#thread-list-item-template").html())},s.prototype.addSearchAlert=function(e,t){var s=new Backbone.Model({message:e,css_class:t||""});return this.searchAlertCollection.add(s),s},s.prototype.removeSearchAlert=function(e){return this.searchAlertCollection.remove(e)},s.prototype.clearSearchAlerts=function(){return this.searchAlertCollection.reset()},s.prototype.reloadDisplayedCollection=function(e){var t,s,i,n;this.clearSearchAlerts(),n=e.get("id"),s=this.renderThread(e),i=this.$(".forum-nav-thread[data-id="+n+"]"),t=0!==i.has(".forum-nav-thread-link.is-active").length,i.replaceWith(s),this.showMetadataAccordingToSort(),this.supportsActiveThread&&t&&this.setActiveThread(n)},s.prototype.addAndSelectThread=function(e){var t=e.get("commentable_id"),s=this;return this.retrieveDiscussion(t,function(){return s.trigger("thread:created",e.get("id"))})},s.prototype.ignoreClick=function(e){return e.stopPropagation()},s.prototype.render=function(){var e=this;return this.timer=0,this.$el.empty(),edx.HtmlUtils.append(this.$el,this.template({isDiscussionDivisionEnabled:this.courseSettings.get("is_discussion_division_enabled"),isPrivilegedUser:DiscussionUtil.isPrivilegedUser()})),this.hideReadState&&this.$(".forum-nav-filter-main").addClass("is-hidden"),this.$(".forum-nav-sort-control option").removeProp("selected"),this.$(".forum-nav-sort-control option[value="+this.collection.sort_preference+"]").prop("selected",!0),this.displayedCollection.on("reset",this.renderThreads),this.displayedCollection.on("thread:remove",this.renderThreads),this.displayedCollection.on("change:commentable_id",function(){"commentables"===e.mode&&e.retrieveDiscussions(e.discussionIds.split(","))}),this.renderThreads(),this},s.prototype.renderThreads=function(){var e,t,s,i;for(this.$(".forum-nav-thread-list").empty(),s=0,i=this.displayedCollection.models.length;i>s;s++)t=this.displayedCollection.models[s],e=this.renderThread(t),this.$(".forum-nav-thread-list").append(e);0===this.$(".forum-nav-thread-list li").length&&(this.clearSearchAlerts(),this.addSearchAlert(gettext("There are no posts in this topic yet."))),this.showMetadataAccordingToSort(),this.renderMorePages(),this.trigger("threads:rendered")},s.prototype.showMetadataAccordingToSort=function(){var e=this.$(".forum-nav-thread-votes-count"),t=this.$(".forum-nav-thread-unread-comments-count"),s=this.$(".forum-nav-thread-comments-count");switch(e.hide(),s.hide(),t.hide(),this.$(".forum-nav-sort-control").val()){case"votes":e.show();break;default:t.show(),s.show()}},s.prototype.renderMorePages=function(){this.displayedCollection.hasMorePages()&&edx.HtmlUtils.append(this.$(".forum-nav-thread-list"),edx.HtmlUtils.template($("#nav-load-more-link").html())({}))},s.prototype.getLoadingContent=function(e){return edx.HtmlUtils.template($("#nav-loading-template").html())({srText:e})},s.prototype.loadMorePages=function(e){var t,s,i,n,o,r,a=this;switch(e&&e.preventDefault(),i=this.$(".forum-nav-load-more"),i.empty(),edx.HtmlUtils.append(i,this.getLoadingContent(gettext("Loading more threads"))),n=i.find(".forum-nav-loading"),DiscussionUtil.makeFocusTrap(n),n.focus(),o={filter:this.filter},this.mode){case"search":o.search_text=this.current_search,this.group_id&&(o.group_id=this.group_id);break;case"followed":o.user_id=window.user.id;break;case"user":o.user_id=this.$el.parent().data("user-id");break;case"commentables":o.commentable_ids=this.discussionIds,this.group_id&&(o.group_id=this.group_id);break;case"all":this.group_id&&(o.group_id=this.group_id)}return r=this.collection.last(),s=r?r.get("id"):void 0,s?this.once("threads:rendered",function(){var e=".forum-nav-thread[data-id='"+s+"'] + .forum-nav-thread .forum-nav-thread-link";return $(e).focus()}):this.once("threads:rendered",function(){var e=$(".forum-nav-thread-link").first();return e?e.focus():void 0}),t=function(){a.renderThreads(),DiscussionUtil.discussionAlert(gettext("Error"),gettext("Additional posts could not be loaded. Refresh the page and try again."))},this.collection.retrieveAnotherPage(this.mode,o,{sort_key:this.$(".forum-nav-sort-control").val()},t)},s.prototype.containsMarkup=function(e){var t="![",s=/\$/g,i=-1!==e.indexOf(t),n=(e.match(s)||[]).length>1;return i||n},s.prototype.renderThread=function(e){var t=e.get("comments_count"),s=e.get("unread_comments_count"),i=!e.get("read")&&s===t,n=this.containsMarkup(e.get("body"))?"":e.get("body"),o=_.extend({neverRead:i,threadUrl:e.urlFor("retrieve"),threadPreview:n,showThreadPreview:this.showThreadPreview,hideReadState:this.hideReadState},e.toJSON());return $(this.threadListItemTemplate(o).toString())},s.prototype.threadSelected=function(e){var t;return t=$(e.target).closest(".forum-nav-thread").attr("data-id"),this.supportsActiveThread&&this.setActiveThread(t),this.trigger("thread:selected",t),!1},s.prototype.threadRemoved=function(e){this.trigger("thread:removed",e)},s.prototype.setActiveThread=function(e){var t;this.$(".forum-nav-thread-link").find(".sr").remove(),this.$(".forum-nav-thread[data-id!='"+e+"'] .forum-nav-thread-link").removeClass("is-active"),t=edx.HtmlUtils.joinHtml(edx.HtmlUtils.HTML('<span class="sr">'),edx.HtmlUtils.ensureHtml(gettext("Current conversation")),edx.HtmlUtils.HTML("</span>")).toString(),this.$(".forum-nav-thread[data-id='"+e+"'] .forum-nav-thread-link").addClass("is-active").find(".forum-nav-thread-wrapper-1").prepend(t)},s.prototype.selectTopic=function(e){var t,s,i;return i=e.closest(".forum-nav-browse-menu-item"),i.hasClass("forum-nav-browse-menu-all")?(this.discussionIds="",this.$(".forum-nav-filter-cohort").show(),this.retrieveAllThreads()):i.hasClass("forum-nav-browse-menu-following")?(this.retrieveFollowed(),this.$(".forum-nav-filter-cohort").hide()):(t=i.find(".forum-nav-browse-menu-item").andSelf(),s=t.filter("[data-discussion-id]").map(function(e,t){return $(t).data("discussion-id")}).get(),this.retrieveDiscussions(s),this.$(".forum-nav-filter-cohort").toggle(i.data("divided")===!0))},s.prototype.chooseFilter=function(){return this.filter=$(".forum-nav-filter-main-control :selected").val(),this.clearSearchAlerts(),this.retrieveFirstPage()},s.prototype.chooseGroup=function(){return this.group_id=this.$(".forum-nav-filter-cohort-control :selected").val(),this.retrieveFirstPage()},s.prototype.retrieveDiscussion=function(e,t){var s=DiscussionUtil.urlFor("retrieve_discussion",e),i=this;return DiscussionUtil.safeAjax({url:s,type:"GET",success:function(e){i.collection.current_page=e.page,i.collection.pages=e.num_pages,i.collection.reset(e.discussion_data),Content.loadContentInfos(e.annotated_content_info),i.displayedCollection.reset(i.collection.models),t&&t()}})},s.prototype.retrieveDiscussions=function(e){return this.discussionIds=e.join(","),this.mode="commentables",this.retrieveFirstPage()},s.prototype.retrieveAllThreads=function(){return this.mode="all",this.retrieveFirstPage()},s.prototype.retrieveFirstPage=function(e){return this.collection.current_page=0,this.$(".forum-nav-thread-list").empty(),this.collection.models=[],this.loadMorePages(e)},s.prototype.sortThreads=function(e){return this.displayedCollection.setSortComparator(this.$(".forum-nav-sort-control").val()),this.retrieveFirstPage(e)},s.prototype.performSearch=function(e){this.trigger("search:initiated"),this.searchFor(e.val(),e)},s.prototype.searchFor=function(e,t){var s=DiscussionUtil.urlFor("search"),i=this;return this.clearSearchAlerts(),this.clearFilters(),this.mode="search",this.current_search=e,DiscussionUtil.safeAjax({$elem:t,data:{text:e},url:s,type:"GET",dataType:"json",$loading:$,loadingCallback:function(){var e=i.$(".forum-nav-thread-list");e.empty(),edx.HtmlUtils.append(e,edx.HtmlUtils.joinHtml(edx.HtmlUtils.HTML("<li class='forum-nav-load-more'>"),i.getLoadingContent(gettext("Loading posts list")),edx.HtmlUtils.HTML("</li>")))},loadedCallback:function(){return i.$(".forum-nav-thread-list .forum-nav-load-more").remove()},success:function(t,s){var n,o;return"success"===s&&(i.collection.reset(t.discussion_data),i.clearSearchAlerts(),Content.loadContentInfos(t.annotated_content_info),i.collection.current_page=t.page,i.collection.pages=t.num_pages,_.isNull(t.corrected_text)?0===t.discussion_data.length&&(i.addSearchAlert(gettext("No posts matched your query.")),i.displayedCollection.models=[]):(o=_.escape(gettext("No results found for {original_query}. Showing results for {suggested_query}.")),n=edx.HtmlUtils.interpolateHtml(o,{original_query:edx.HtmlUtils.joinHtml(edx.HtmlUtils.HTML("<em>"),e,edx.HtmlUtils.HTML("</em>")),suggested_query:edx.HtmlUtils.joinHtml(edx.HtmlUtils.HTML("<em>"),t.corrected_text,edx.HtmlUtils.HTML("</em>"))}),i.addSearchAlert(n)),0!==i.collection.models.length&&i.displayedCollection.reset(i.collection.models),e)?i.searchForUser(e):t}})},s.prototype.searchForUser=function(e){var t=this;return DiscussionUtil.safeAjax({data:{username:e},url:DiscussionUtil.urlFor("users"),type:"GET",dataType:"json",error:function(){},success:function(e){var s,i;e.users.length>0&&(i=edx.HtmlUtils.joinHtml(edx.HtmlUtils.interpolateHtml(edx.HtmlUtils.HTML('<a class="link-jump" href="{url}">'),{url:DiscussionUtil.urlFor("user_profile",e.users[0].id)}),e.users[0].username,edx.HtmlUtils.HTML("</a>")),s=edx.HtmlUtils.interpolateHtml(gettext("Show posts by {username}."),{username:i}),t.addSearchAlert(s,"search-by-user"))}})},s.prototype.clearFilters=function(){return this.$(".forum-nav-filter-main-control").val("all"),this.$(".forum-nav-filter-cohort-control").val("all")},s.prototype.retrieveFollowed=function(){return this.mode="followed",this.retrieveFirstPage()},s.prototype.updateEmailNotifications=function(){var e,t,s;e=$("input.email-setting"),t=e.prop("checked"),s=t?"enable_notifications":"disable_notifications",DiscussionUtil.safeAjax({url:DiscussionUtil.urlFor(s),type:"POST",error:function(){e.prop("checked",!t)}})},s}.call(this,Backbone.View))}.call(window),RequireJS.define("common/js/discussion/views/discussion_thread_list_view",function(){}),RequireJS.define("text",{load:function(e){throw new Error("Dynamic load not allowed: "+e)}}),RequireJS.define("text!discussion/templates/fake-breadcrumbs.underscore",[],function(){return'<div class="breadcrumbs">\n    <span class="nav-item">\n        <button class="btn-link all-topics">\n            <span class="icon fa fa-bars" aria-hidden="true"></span><%- gettext(\'All Topics\') %>\n        </button>\n    </span>\n    <% contents.forEach(function(content) { %>\n        <span class="fa fa-angle-right"></span>\n        <span class="nav-item"><%- content %></span>\n    <% }); %>\n</div>\n'}),function(e){"use strict";RequireJS.define("discussion/js/views/discussion_fake_breadcrumbs",["backbone","gettext","edx-ui-toolkit/js/utils/html-utils","text!discussion/templates/fake-breadcrumbs.underscore"],function(e,t,s,i){var n=e.View.extend({initialize:function(){this.template=s.template(i),this.listenTo(this.model,"change",this.render),this.render()},render:function(){var e=this.model.attributes;return s.setHtml(this.$el,this.template(e)),this}});return n})}.call(this,define||RequireJS.define),RequireJS.define("text!discussion/templates/search.underscore",[],function(){return'<input\n    class="field-input form-control input-text search-input"\n    type="search"\n    name="search"\n    id="search"\n    placeholder="<%- gettext("Search all posts") %>"\n/>\n<label class="field-label" for="search" id="search-hint" aria-label=\'<%- gettext("Search all posts") %>\'><%- gettext("Search all posts") %></label>\n<button class="btn btn-outline-primary btn-small search-button" type="button"><%- gettext("Search") %></button>\n'}),function(e){"use strict";RequireJS.define("discussion/js/views/discussion_search_view",["underscore","backbone","edx-ui-toolkit/js/utils/html-utils","edx-ui-toolkit/js/utils/constants","text!discussion/templates/search.underscore"],function(e,t,s,i,n){var o=t.View.extend({initialize:function(t){e.extend(this,e.pick(t,["discussionBoardView"])),this.template=s.template(n),this.listenTo(this.model,"change",this.render),this.render()},render:function(){return s.setHtml(this.$el,this.template()),this}});return o})}.call(this,define||RequireJS.define),RequireJS.define("text!discussion/templates/discussion-home.underscore",[],function(){return'<div class="discussion-article view-discussion-home">\n  <section class="home-header">\n    <span class="label"><%- gettext("Discussion Home") %></span>\n    <% if (window.courseName) { %>\n      <h2 class="home-title"><%- window.courseName %></h2>\n    <% } %>\n  </section>\n\n  <% if (window.ENABLE_DISCUSSION_HOME_PANEL) { %>\n    <span class="label label-settings">\n      <%- interpolate(\n            gettext("How to use %(platform_name)s discussions"),\n            {platform_name: window.PLATFORM_NAME}, true\n          ) %>\n    </span>\n    <table class="home-helpgrid">\n      <tr class="helpgrid-row helpgrid-row-navigation">\n        <th scope="row" class="row-title"><%- gettext("Find discussions") %></td>\n        <td class="row-item">\n          <span class="icon fa fa-reorder" aria-hidden="true"></span>\n          <span class="row-description"><%- gettext("Use the All Topics menu to find specific topics.") %></span>\n        </td>\n        <td class="row-item">\n          <span class="icon fa fa-search" aria-hidden="true"></span>\n          <span class="row-description"><%- gettext("Search all posts") %></span>\n        </td>\n        <td class="row-item">\n          <span class="icon fa fa-sort" aria-hidden="true"></span>\n          <span class="row-description"><%- gettext("Filter and sort topics") %></span>\n        </td>\n      </tr>\n      <tr class="helpgrid-row helpgrid-row-participation">\n        <th scope="row" class="row-title"><%- gettext("Engage with posts") %></td>\n        <td class="row-item">\n          <span class="icon fa fa-plus" aria-hidden="true"></span>\n          <span class="row-description"><%- gettext("Vote for good posts and responses") %></span>\n        </td>\n        <td class="row-item">\n          <span class="icon fa fa-flag" aria-hidden="true"></span>\n          <span class="row-description"><%- gettext("Report abuse, topics, and responses") %></span>\n        </td>\n        <td class="row-item">\n          <span class="icon fa fa-star" aria-hidden="true"></span>\n          <span class="row-description"><%- gettext("Follow or unfollow posts") %></span>\n        </td>\n      </tr>\n      <tr class="helpgrid-row helpgrid-row-notification">\n        <th scope="row" class="row-title"><%- gettext(\'Receive updates\') %></td>\n        <td class="row-item-full" colspan="3">\n          <label for="email-setting-checkbox">\n            <span class="sr"><%- gettext("Toggle Notifications Setting") %></span>\n            <span class="notification-checkbox">\n              <input type="checkbox" id="email-setting-checkbox" class="email-setting" name="email-notification"/>\n              <span class="icon fa fa-envelope" aria-hidden="true"></span>\n            </span>\n          </label>\n          <span class="row-description"><%- gettext("Check this box to receive an email digest once a day notifying you about new, unread activity from posts you are following.") %></span>\n        </td>\n      </tr>\n    </table>\n  <% } %>\n</div>\n'}),function(e){"use strict";RequireJS.define("discussion/js/views/discussion_board_view",["underscore","backbone","edx-ui-toolkit/js/utils/html-utils","edx-ui-toolkit/js/utils/constants","common/js/discussion/utils","common/js/discussion/views/discussion_thread_list_view","discussion/js/views/discussion_fake_breadcrumbs","discussion/js/views/discussion_search_view","text!discussion/templates/discussion-home.underscore"],function(e,t,s,i,n,o,r,a,d){var u=t.View.extend({events:{"click .forum-nav-browse-title":"selectTopicHandler","click .all-topics":"toggleBrowseMenu","keypress .forum-nav-browse-filter-input":function(e){return n.ignoreEnterKey(e)},"keyup .forum-nav-browse-filter-input":"filterTopics","keydown .forum-nav-browse-filter-input":"keyboardBinding","click .forum-nav-browse-menu-wrapper":"ignoreClick","keydown .search-input":"performSearch","click .search-button":"performSearch","topic:selected":"clearSearch"},initialize:function(e){this.courseSettings=e.courseSettings,this.sidebar_padding=10,this.current_search="",this.mode="all",this.discussion=e.discussion,this.filterInputReset(),this.selectedTopic=$(".forum-nav-browse-menu-item:visible .forum-nav-browse-title.is-focused"),this.listenTo(this.model,"change",this.render)},render:function(){return this.discussionThreadListView=new o({collection:this.discussion,el:this.$(".discussion-thread-list-container"),courseSettings:this.courseSettings,supportsActiveThread:!0,mode:this.mode}).render(),this.searchView=new a({el:this.$(".forum-search")}).render(),this.renderBreadcrumbs(),this.showBrowseMenu(!0),this},renderBreadcrumbs:function(){var e=t.Model.extend({defaults:{contents:[]}});this.breadcrumbs=new r({el:$(".has-breadcrumbs"),model:new e,events:{"click .all-topics":function(e){e.preventDefault()}}}).render()},isBrowseMenuVisible:function(){return this.$(".forum-nav-browse-menu-wrapper").is(":visible")},showBrowseMenu:function(e){
this.isBrowseMenuVisible()||(this.$(".forum-nav-browse-menu-wrapper").show(),this.$(".forum-nav-thread-list-wrapper").hide(),e||($(".forum-nav-browse-filter-input").focus(),this.filterInputReset()))},hideBrowseMenu:function(){var e=this.$(".forum-nav-browse-title.is-focused");this.isBrowseMenuVisible()&&(e.removeClass("is-focused"),this.$(".forum-nav-browse-menu-wrapper").hide(),this.$(".forum-nav-thread-list-wrapper").show(),"undefined"!==this.selectedTopicId&&this.$(".forum-nav-browse-filter-input").attr("aria-activedescendant",this.selectedTopicId))},toggleBrowseMenu:function(e){var t=this.$(".forum-nav-browse-filter-input").val();e.preventDefault(),e.stopPropagation(),this.isBrowseMenuVisible()?this.hideBrowseMenu():(""!==t&&this.filterTopics(t),this.showBrowseMenu()),this.breadcrumbs.model.set("contents",[]),this.clearSearch()},performSearch:function(e){(e.which===i.keyCodes.enter||"click"===e.type)&&(e.preventDefault(),this.hideBrowseMenu(),this.breadcrumbs.model.set("contents",["Search Results"]),this.discussionThreadListView.performSearch($(".search-input",this.$el)))},clearSearch:function(){this.$(".search-input").val(""),this.discussionThreadListView.clearSearchAlerts()},goHome:function(){var e=n.urlFor("notifications_status",window.user.get("id"));s.append(this.$(".forum-content").empty(),s.template(d)({})),this.$(".forum-nav-thread-list a").removeClass("is-active").find(".sr").remove(),this.$("input.email-setting").bind("click",this.discussionThreadListView.updateEmailNotifications),n.safeAjax({url:e,type:"GET",success:function(e){$("input.email-setting").prop("checked",e.status)}})},filterInputReset:function(){this.filterEnabled=!0,this.selectedTopicIndex=-1,this.selectedTopicId=null},selectOption:function(e){var t,s;this.selectedTopic.length>0&&this.selectedTopic.removeClass("is-focused"),e&&(e.addClass("is-focused"),t=e.parent().attr("id"),s=e.text(),this.selectedTopic=e,this.selectedTopicId=t,this.$(".forum-nav-browse-filter-input").attr("aria-activedescendant",t).val(s))},keyboardBinding:function(e){var t,s,n,o=e.which,r=$(".forum-nav-browse-filter-input"),a=$(".forum-nav-browse-menu-item:visible"),d=a.length,u=a.eq(0).find(".forum-nav-browse-title").eq(0);switch(o){case i.keyCodes.enter:t=a.find(".forum-nav-browse-title.is-focused"),""!==r.val()&&(t.trigger("click"),this.filterInputReset());break;case i.keyCodes.esc:this.toggleBrowseMenu(e),this.$(".forum-nav-browse-filter-input").val(""),this.filterInputReset(),$(".all-topics").trigger("click");break;case i.keyCodes.up:this.selectedTopicIndex>0&&(this.selectedTopicIndex-=1,this.isBrowseMenuVisible()&&(s=$(".forum-nav-browse-menu-item:visible").eq(this.selectedTopicIndex).find(".forum-nav-browse-title").eq(0),this.filterEnabled=!1,u.removeClass("is-focused"),s.addClass("is-focused")),this.selectOption(s));break;case i.keyCodes.down:this.selectedTopicIndex<d-1&&(this.selectedTopicIndex+=1,this.isBrowseMenuVisible()&&(n=$(".forum-nav-browse-menu-item:visible").eq(this.selectedTopicIndex).find(".forum-nav-browse-title").eq(0),this.filterEnabled=!1,u.removeClass("is-focused"),n.addClass("is-focused")),this.selectOption(n))}},filterTopics:function(){var e,t,s,i=this;return t=this.$(".forum-nav-browse-filter-input").val(),e=this.$(".forum-nav-browse-menu-item"),0===t.length?(e.find(".forum-nav-browse-title.is-focused").removeClass("is-focused"),e.show()):(i.filterEnabled&&(e.hide(),s=e.each(function(e,s){var n,o,r=$(s);r.is(":visible")||(o=i.getPathText(r).toLowerCase(),t.split(" ").every(function(e){return-1!==o.search(e.toLowerCase())})&&(n=r.parents(".forum-nav-browse-menu-item").andSelf(),n.add(r.find(".forum-nav-browse-menu-item")).show()))})),s)},getPathText:function(e){var t,s;return t=e.parents(".forum-nav-browse-menu-item").andSelf(),s=t.children(".forum-nav-browse-title").map(function(e,t){return $(t).text()}).get(),s.join(" / ")},selectTopicHandler:function(e){var t=$(e.target).closest(".forum-nav-browse-menu-item");return e.preventDefault(),this.hideBrowseMenu(),this.trigger("topic:selected",this.getBreadcrumbText(t)),this.discussionThreadListView.selectTopic($(e.target))},getBreadcrumbText:function(e){var t=e.parents(".forum-nav-browse-submenu"),s=[],i=$(".forum-nav-browse-title",e).first().contents().last().text().trim();return t.each(function(e,t){s.push($(t).siblings(".forum-nav-browse-title").first().contents().last().text().trim())}),"All Discussions"!==i&&s.push(i),s}});return u})}.call(this,define||RequireJS.define),function(e){"use strict";RequireJS.define("discussion/js/discussion_board_factory",["jquery","backbone","common/js/discussion/content","common/js/discussion/discussion","common/js/discussion/utils","common/js/discussion/models/discussion_course_settings","common/js/discussion/models/discussion_user","common/js/discussion/views/new_post_view","discussion/js/discussion_router","discussion/js/views/discussion_board_view"],function(e,t,s,i,n,o,r,a,d,u){return function(t){var c,l,h,p,m,f,g=t.userInfo,v=t.sortPreference,_=t.threads,w=t.threadPages,y=t.isCommentableDivided,b=t.contentInfo,$=new r(g);void 0===t.roles&&(t.roles={}),n.loadRoles(t.roles),window.$$course_id=t.courseId,window.courseName=t.courseName,n.setUser($),window.user=$,s.loadContentInfos(b),c=new i(_,{pages:w,sort:v,is_commentable_divided:y}),l=new o(t.courseSettings),p=new u({el:e(".discussion-board"),discussion:c,courseSettings:l}),p.render(),h=new a({el:e(".new-post-article"),collection:c,course_settings:l,discussionBoardView:p,mode:"tab",startHeader:2,topicId:t.defaultTopicId}),h.render(),m=new d({rootUrl:t.rootUrl,discussion:c,courseSettings:l,discussionBoardView:p,newPostView:h}),m.start(),f={"topic:selected":function(e){m.discussionBoardView.breadcrumbs.model.set("contents",e)},"thread:selected":function(){m.discussionBoardView.searchView.clearSearch()}},Object.keys(f).forEach(function(e){m.discussionBoardView.on(e,f[e])})}})}.call(this,define||RequireJS.define);